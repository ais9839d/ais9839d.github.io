<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#F9F4F0">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>麥克諾尼 | 日式寵物沙龍</title>
<meta name="description" content="日式寵物美容、洗護專門店">
    <link rel="icon" href="logo.jpg">
    <link rel="apple-touch-icon" href="logo.jpg">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>   
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#F9F4F0',       /* 韓系米白背景 */
                            primary: '#C7B299',  /* 韓國奶茶色 (主色) */
                            secondary: '#E6CCCA',/* 乾燥玫瑰粉 (點綴) */
                            dark: '#8A7B70',     /* 深奶茶 (邊框/副標) */
                            text: '#594A42',     /* 深焙咖啡 (文字) */
                            light: '#9D816F',    /* 淺棕色 (說明文字) */
                            surface: 'rgba(255, 255, 255, 0.65)' /* 磨砂玻璃背景 */
                        },
                    },
                    fontFamily: {
                        sans: ['Arial', 'Helvetica', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
/* 全域設定 */
        * {
            /* 移除手機點擊時的預設高亮色塊 (最重要!) */
            -webkit-tap-highlight-color: transparent;
            /* 讓捲動更滑順 */
            -webkit-overflow-scrolling: touch;
        }

        body {
            background-color: #F9F4F0;
            color: #594A42;
            /* 使用系統原生字體，看起來更像 App */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow-x: hidden;
            /* 禁止整個頁面被下拉回彈 (避免露出瀏覽器底色) */
            overscroll-behavior-y: none;
            /* 禁止長按選取文字 (更像 App 介面) */
            -webkit-user-select: none;
            user-select: none;
            /* 適配 iPhone 安全區域 (避免被瀏海或 Home Bar 擋住) */
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* 讓輸入框依然可以選取文字 */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        
        /* 避免 iOS 輸入框字體太小導致自動放大 (雖然我們已經禁用了 zoom，但這是雙重保險) */
        input, select, textarea {
            font-size: 16px !important; 
        }

        /* 玻璃擬態卡片 */
        .glass-card {
            background-color: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 1.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        /* 選項卡片樣式 */
        .option-card {
            cursor: pointer;
            border: 1px solid rgba(199, 178, 153, 0.2); /* brand-primary/20 */
            background-color: rgba(255, 255, 255, 0.4);
            transition: all 0.2s;
        }
        
        /* 選中狀態 (由 JS 控制 class) */
        .option-card.selected {
            background-color: #ffffff;
            border-color: rgba(199, 178, 153, 0.8);
            box-shadow: 0 4px 20px rgba(184, 166, 155, 0.15);
        }

        /* 輸入框樣式 */
        .input-style {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(199, 178, 153, 0.2);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: #594A42; /* brand-text */
            outline: none;
            transition: all 0.2s;
        }
        .input-style:focus {
            background-color: #ffffff;
            border-color: rgba(199, 178, 153, 0.5);
        }
        .input-style::placeholder {
            color: #94a3b8;
        }

        /* 動畫 */
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(2deg); }
        }
        .animate-float { animation: float 8s ease-in-out infinite; }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.6s ease-out forwards; }

        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .animate-scroll { animation: scroll 20s linear infinite; }

        /* 隱藏捲軸但保留功能 */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

/* 頁面切換控制 */
.view-section {
    display: none; /* 預設隱藏所有區塊 */
    animation: fadeIn 0.4s ease-in-out;
}
.view-section.active {
    display: block; /* 只有 active 的顯示 */
}

/* 新增一個簡單的淡入動畫 */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

        
/* 簽名板樣式 */
.signature-pad {
    touch-action: none;
    background-color: #fff;
    background-image: linear-gradient(#e5e7eb 1px, transparent 1px),
    linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
    background-size: 20px 20px;
}
    /* 針對簽名 Modal 的底部按鈕區塊修復 */
    #signature-modal {
        /* 確保 Modal 高度不超過視窗，並使用 Flex 排版 */
        height: 100vh; 
        height: 100dvh; /* 針對手機瀏覽器動態高度 */
    }
    
    /* 這是畫布的中間區塊 */
    #signature-modal .flex-1 {
        /* 確保它會撐開中間的空間，但不會把按鈕擠出去 */
        min-height: 0; 
        position: relative;
    }
/* Toast 提示樣式 - 麥克諾尼風格 */
        .toast-container {
            position: fixed;
            top: calc(20px + env(safe-area-inset-top));
            right: 0;
            left: 0;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center; /* 居中顯示 */
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            min-width: 280px;
            max-width: 85%;
            padding: 12px 20px;
            border-radius: 50px; /* 膠囊狀 */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 30px rgba(89, 74, 66, 0.15); /* brand-text shadow */
            border: 1px solid rgba(199, 178, 153, 0.3); /* brand-primary border */
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(-50px);
            opacity: 0;
            animation: toastSlideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            pointer-events: auto;
        }

        @keyframes toastSlideDown {
            to { transform: translateY(0); opacity: 1; }
        }

        .toast.removing {
            animation: toastFadeOut 0.3s ease forwards;
        }

        @keyframes toastFadeOut {
            to { transform: translateY(-20px); opacity: 0; }
        }

        /* 狀態顏色指示線 (左側小圓點) */
        .toast::before {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .toast.success::before { background-color: #10b981; box-shadow: 0 0 8px #10b981; }
        .toast.error::before { background-color: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .toast.warning::before { background-color: #f59e0b; box-shadow: 0 0 8px #f59e0b; }

        .toast-icon { width: 20px; height: 20px; flex-shrink: 0; }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 700; font-size: 0.9rem; color: #594A42; margin-bottom: 2px; }
        .toast-message { font-size: 0.75rem; color: #8A7B70; font-weight: 500; }
/* ====== 錯誤欄位紅字提示 (新增) ====== */
.field-error {
    border-color: #ef4444 !important;
    background-color: #fff5f5 !important;
}
.field-error-message {
    color: #ef4444;
    font-size: 0.75rem;
    font-weight: 600;
    margin-top: 0.25rem;
}
.field-error-box {
    border-color: #ef4444 !important;
    background-color: #fff5f5 !important;
}

    </style>
</head>
<body class="min-h-screen pb-28 relative">
<!-- Toast 容器 -->
<div class="toast-container" id="toast-container"></div>
    <div class="fixed rounded-full blur-[120px] -z-10 opacity-40 bg-brand-secondary top-[-15%] right-[-25%] w-[500px] h-[500px] animate-float"></div>
    <div class="fixed rounded-full blur-[100px] -z-10 opacity-50 bg-[#CDB5A8] bottom-[5%] left-[-20%] w-[400px] h-[400px] animate-float" style="animation-direction: reverse;"></div>

<nav class="fixed top-0 w-full z-40 bg-brand-bg/80 backdrop-blur-md px-6 pb-3 flex justify-between items-center shadow-sm pt-[env(safe-area-inset-top)]">
        <div class="flex items-center gap-4 cursor-pointer" onclick="app.switchView('home')">
            <img src="logo.jpg" onerror="this.src='https://placehold.co/100x100?text=Logo'" alt="Logo" class="w-12 h-12 object-cover rounded-full border border-brand-primary/30">
            <div class="flex items-center">
                <span class="text-3xl font-bold tracking-tighter text-brand-text">麥克諾尼</span>
                <span class="text-2xl text-brand-primary/40 mx-2 font-light">|</span>
                <div class="flex flex-col justify-center">
                    <span class="text-[13px] font-bold leading-tight text-brand-dark">日式寵物沙龍</span>
                    <span class="text-[10px] text-brand-light tracking-wider leading-tight font-medium uppercase">ペットサロン</span>
                </div>
            </div>
        </div>
        <button id="back-btn" onclick="app.switchView('home')" class="text-brand-light hover:text-brand-text transition-colors hidden">
            <i data-lucide="arrow-left" class="w-6 h-6"></i>
        </button>
    </nav>

<main class="pt-[calc(6rem+env(safe-area-inset-top))] px-5 max-w-lg mx-auto space-y-8">
        
        <div id="view-home" class="view-section active animate-fade-in space-y-8">
            <div class="text-center space-y-4">
<div class="w-28 h-28 mx-auto mb-2 rounded-full p-1 border border-brand-primary/20 overflow-hidden cursor-pointer" onclick="app.checkAdminAccess()">
    <img src="logo.jpg" onerror="this.src='https://placehold.co/200x200?text=Logo'" alt="Logo" class="w-full h-full object-cover rounded-full">
</div>
                <h1 class="text-2xl font-bold font-serif text-brand-primary italic">毛小孩的笑容是最甜蜜的糖果</h1>
                <div class="flex flex-wrap justify-center gap-2 px-4">
                    <span class="text-[10px] text-brand-light bg-brand-primary/10 px-2 py-0.5 rounded-full tracking-wider">#台北市松山區</span>
                    <span class="text-[10px] text-brand-light bg-brand-primary/10 px-2 py-0.5 rounded-full tracking-wider">#全新裝修空間</span>
                    <span class="text-[10px] text-brand-light bg-brand-primary/10 px-2 py-0.5 rounded-full tracking-wider">#全程手工吹整</span>
                    <span class="text-[10px] text-brand-light bg-brand-primary/10 px-2 py-0.5 rounded-full tracking-wider">#日式寵物美容</span>
                    <span class="text-[10px] text-brand-light bg-brand-primary/10 px-2 py-0.5 rounded-full tracking-wider">#合格寵物美容師</span>
                    <span class="text-[10px] text-brand-light bg-brand-primary/10 px-2 py-0.5 rounded-full tracking-wider">#客製化皮毛護理</span>
                    <span class="text-[10px] text-brand-light bg-brand-primary/10 px-2 py-0.5 rounded-full tracking-wider">#每日消毒清潔</span>
                    <span class="text-[10px] text-brand-light bg-brand-primary/10 px-2 py-0.5 rounded-full tracking-wider">#高齡犬友善</span>
                </div>
                <p class="text-xs text-brand-light leading-relaxed px-4 text-justify mx-auto max-w-xs">
                    承襲日式寵物文化 30 年。我們秉持「家人」的初衷，提供最高品質的洗護與專業諮詢。
                </p>
            </div>

<div 
    class="relative w-full h-32 rounded-2xl cursor-pointer shadow-sm border border-white/60 overflow-hidden isolate transform-gpu" 
    onclick="app.switchView('products')"
    role="button"
    aria-label="查看嚴選日系洗護產品"
    style="-webkit-mask-image: -webkit-radial-gradient(white, black);"
>
    <div class="absolute inset-0 z-20 flex flex-col justify-center items-center text-white bg-black/25 backdrop-blur-[1px] pointer-events-none">
        <h3 class="font-bold text-lg tracking-widest drop-shadow-md">嚴選日系洗護</h3>
        <p class="text-[10px] opacity-90 uppercase">Premium Japanese Spa Showcase</p>
    </div>

    <div class="flex w-[400%] h-full animate-scroll will-change-transform">
        <div class="flex w-full h-full" id="banner-container"></div>
    </div>
</div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="app.switchView('grooming')" class="glass-card p-6 text-left hover:-translate-y-1 transition-all group">
                    <i data-lucide="scissors" class="w-6 h-6 mb-4 text-brand-primary"></i>
                    <h3 class="font-bold text-brand-text">美容預約</h3>
                    <p class="text-[10px] text-brand-light mt-1">建立電子契約與服務</p>
                </button>
                <button onclick="app.switchView('products')" class="glass-card p-6 text-left hover:-translate-y-1 transition-all group">
                    <i data-lucide="sparkles" class="w-6 h-6 mb-4 text-brand-primary"></i>
                    <h3 class="font-bold text-brand-text">產品介紹</h3>
                    <p class="text-[10px] text-brand-light mt-1">查看高級洗劑詳情</p>
                </button>
            </div>

            <div class="glass-card p-5 border-l-4 border-brand-primary space-y-3 shadow-sm">
                <h4 class="font-bold text-sm flex items-center gap-2 text-brand-text">
                    <i data-lucide="store" class="w-4 h-4 text-brand-primary"></i> 門市資訊
                </h4>
                <ul class="text-xs space-y-2">
                    <li><span class="text-brand-light w-16 inline-block">營業時間</span> 09:00 - 18:00</li>
                    <li><span class="text-brand-light w-16 inline-block">公休日</span> 週三、週日</li>
                    <li><span class="text-brand-light w-16 inline-block">預約電話</span> 02-27129404</li>
                </ul>
            </div>

<div class="w-full max-w-sm mx-auto pt-4 pb-8">
                <div class="bg-white/80 backdrop-blur-md rounded-full shadow-lg p-1.5 flex justify-between items-center px-6 border border-white/60">
                    <a href="https://www.facebook.com/p/%E9%BA%A5%E5%85%8B%E8%AB%BE%E5%B0%BC%E6%97%A5%E5%BC%8F%E5%AF%B5%E7%89%A9%E6%B2%99%E9%BE%8D-100092747026399/" target="_blank" rel="noopener noreferrer" class="flex items-center">
                        <i data-lucide="facebook" class="w-5 h-5 text-brand-light cursor-pointer hover:text-blue-600"></i>
                    </a>
                    <a href="https://line.me/ti/p/@ais9839d" target="_blank" class="bg-white text-[#06C755] border border-[#06C755]/20 px-5 py-2.5 rounded-full flex items-center gap-2 shadow-lg -mt-5 hover:scale-105 transition-transform">
                        <img src="line.png" alt="LINE" class="w-5 h-5 object-contain">
                        <span class="text-xs font-bold">預約諮詢</span>
                    </a>
                    <a href="https://www.instagram.com/ais9839d/" target="_blank" rel="noopener noreferrer" class="flex items-center">
                        <i data-lucide="instagram" class="w-5 h-5 text-brand-light cursor-pointer hover:text-pink-600"></i>
                    </a>
                </div>
            </div>
                </div>

        <div id="view-products" class="view-section animate-fade-in space-y-8 pb-20">
            <div class="text-center space-y-2">
                <h2 class="text-xl font-bold">嚴選日系洗護系列</h2>
                <p class="text-[10px] text-brand-light px-6">堅持全程採用日本進口洗劑，給毛孩如空氣般柔軟的呵護</p>
            </div>

            <div class="glass-card p-5 space-y-4 shadow-md bg-white/80">
                <div class="aspect-[21/9] rounded-xl overflow-hidden bg-[#fafafa] flex items-center justify-center">
                    <img src="line_oa_chat_260116_170322.jpg" onerror="this.src='https://placehold.co/600x300?text=Product'" class="max-w-full max-h-full object-contain" alt="ZOIC Cats">
                </div>
                <div class="text-center">
                    <span class="text-[10px] bg-brand-secondary text-brand-text px-2 py-0.5 rounded-full font-bold mb-2 inline-block tracking-widest uppercase">Hero Product</span>
                    <h3 class="text-lg font-bold text-brand-text">ZOIC 貓咪專用洗護</h3>
                    <p class="text-xs text-brand-light mt-1">針對貓咪膚質開發，極致柔軟與蓬鬆感的完美呈現</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4" id="product-list"></div>
        </div>

        <div id="view-grooming" class="view-section animate-fade-in space-y-6 pb-20">
            <div class="text-center space-y-2">
                <h2 class="text-xl font-bold">美容預約單</h2>
                <p class="text-xs text-brand-light">請填寫詳細資料以建立電子預約契約</p>
            </div>

            <div class="glass-card p-6 border-none bg-white shadow-sm relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-[#06C755]/10 rounded-full blur-3xl"></div>
                <div class="relative z-10 space-y-5">
<div class="text-center space-y-1">
                        <h3 class="text-xl font-black text-brand-text flex items-center justify-center gap-2">
                            <img src="line.png" alt="LINE" class="w-7 h-7 object-contain">
                            加入官方 LINE
                        </h3>
                        <p class="text-xs text-brand-light font-bold">ID: @ais9839d</p>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-3">
                        <a href="https://line.me/ti/p/@ais9839d" target="_blank" class="bg-[#fbf9f6] border border-[#06C755]/30 rounded-2xl p-4 flex flex-col items-center justify-center gap-1 hover:bg-[#06C755]/5 transition-colors group">
                            <div class="w-6 h-6 rounded-full bg-[#06C755] text-white flex items-center justify-center font-black text-xs mb-1">1</div>
                            <span class="font-bold text-base text-[#06C755]">點擊加入好友</span>
                            <div class="mt-1 w-full py-2 bg-[#06C755] text-white rounded-lg text-center font-bold text-xs shadow-md group-hover:scale-105 transition-transform">立即加 LINE</div>
                        </a>
                        <div class="bg-red-50 border border-red-200 rounded-2xl p-4 flex flex-col items-center justify-center gap-1 text-center relative overflow-hidden mt-3">
                            <div class="w-6 h-6 rounded-full bg-red-500 text-white flex items-center justify-center font-black text-xs mb-1 relative z-10">2</div>
                            <span class="font-bold text-base text-red-600 relative z-10">務必「傳送貼圖」</span>
                            <span class="text-[10px] font-bold text-red-500 relative z-10">⚠️ 沒傳貼圖，我們就找不到您囉！</span>
                        </div>
                    </div>

                    <button id="line-check-btn" onclick="app.toggleLineCheck()" class="w-full flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-bold transition-all duration-300 border bg-white text-brand-light border-slate-200">
                        <div id="line-check-icon" class="w-4 h-4 rounded-full border border-current flex items-center justify-center"></div>
                        <span id="line-check-text" class="text-sm">確認：我已完成上述兩步驟</span>
                    </button>
                </div>
            </div>

<form id="booking-form" class="space-y-6" onsubmit="app.handleFormSubmit(event)" novalidate>
              
<section class="glass-card p-6 space-y-4">
    <h3 class="text-sm font-bold flex items-center gap-2 text-brand-dark border-b border-brand-primary/10 pb-2">
        <div class="w-1.5 h-1.5 bg-brand-primary rounded-full"></div> 一、預約基本資料
    </h3>
    
    <div class="space-y-1">                        <label class="text-xs font-bold text-brand-light ml-1">手機號碼 *</label>
                        <div class="flex gap-2">
<input type="tel" name="phone" id="phone"
       pattern="^09\d{8}$"
       minlength="10" maxlength="10"
       class="input-style" required>
<button type="button" onclick="app.handleSearchOldCustomer()" class="whitespace-nowrap px-4 bg-brand-primary text-white text-xs font-bold rounded-xl shadow-sm active:scale-95 transition-transform">帶入紀錄</button>
                        </div>
                        <p class="text-[12px] text-brand-light/80 pl-1 flex items-center gap-1 pt-1">
                            <i data-lucide="info" class="w-3 h-3"></i>
                            曾填寫的客戶，輸入號碼後點擊按鈕可帶入過往資料
                        </p>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-brand-light ml-1">飼主姓名 *</label>
<input type="text" name="ownerName" id="ownerName" class="input-style" required>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-brand-light ml-1">身分證字號 *</label>
<input type="text" name="ownerId" id="ownerId"
       pattern="^[A-Z][12]\d{8}$"
       minlength="10" maxlength="10"
       class="input-style" required
       oninput="this.value=this.value.toUpperCase()">
                        </div>
                    </div>

<div class="space-y-1">
                        <label class="text-xs font-bold text-brand-light ml-1">電子信箱(填寫將寄送契約副本)</label>
                        <input type="email" name="email" id="email" class="input-style" placeholder="example@email.com">
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs font-bold text-brand-light ml-1">通訊地址 *</label>
                        <input type="text" name="address" id="address" class="input-style" placeholder="" required>
                    </div>

                    <div class="grid grid-cols-2 gap-3 bg-brand-bg/50 p-3 rounded-xl border border-brand-primary/10">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-brand-dark ml-1">緊急聯絡人 *</label>
                            <input type="text" name="emergencyName" id="emergencyName" class="input-style" placeholder="" required>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-brand-dark ml-1">緊急電話 *</label>
<input type="tel" id="emergencyPhone" name="emergencyPhone"
       pattern="^09\d{8}$"
       minlength="10" maxlength="10"
       class="input-style" required>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs font-bold text-brand-light ml-1">指定就醫醫院</label>
                        <input type="text" name="preferredClinic" id="preferredClinic" class="input-style" placeholder="若未填寫則送往特約醫院">
                    </div>
                </section>

                <section class="glass-card p-6 space-y-5">
                    <h3 class="text-sm font-bold flex items-center gap-2 text-brand-dark border-b border-brand-primary/10 pb-2">
                        <div class="w-1.5 h-1.5 bg-brand-secondary rounded-full"></div> 二、寵物詳細資料
                    </h3>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-brand-light ml-1">寵物種類 *</label>
                        <div class="flex gap-2">
                            <label class="option-card flex-1 py-3 rounded-xl flex items-center justify-center gap-2 text-sm font-bold" onclick="app.selectSpecies('犬', this)">
                                <input type="radio" name="petSpecies" value="犬" class="hidden" required> 
                                <i data-lucide="dog" class="w-4 h-4"></i> 狗狗
                            </label>
                            <label class="option-card flex-1 py-3 rounded-xl flex items-center justify-center gap-2 text-sm font-bold" onclick="app.selectSpecies('貓', this)">
                                <input type="radio" name="petSpecies" value="貓" class="hidden"> 
                                <i data-lucide="cat" class="w-4 h-4"></i> 貓咪
                            </label>
                        </div>
                    </div>    

                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-brand-light ml-1">名字 *</label>
                            <input type="text" name="petName" id="petName" class="input-style" required>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-brand-light ml-1">品種 *</label>
                            <input type="text" name="breed" id="breed" class="input-style" placeholder="例: 貴賓" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-brand-light ml-1">體重 (kg) *</label>
                            <input type="number" step="0.1" name="weight" id="weight" class="input-style" required>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-brand-light ml-1">年齡 (歲) *</label>
                            <input type="number" name="ageYear" id="ageYear" class="input-style text-center" required oninput="app.checkRisk(this.value)">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-brand-light ml-1">性別 *</label>
                            <div class="flex gap-2">
                                <label class="option-card flex-1 py-2 rounded-xl flex items-center justify-center gap-1 text-xs font-bold" onclick="app.updateRadioStyle(this)">
                                    <input type="radio" name="gender" value="公" class="hidden" required> 公
                                </label>
                                <label class="option-card flex-1 py-2 rounded-xl flex items-center justify-center gap-1 text-xs font-bold" onclick="app.updateRadioStyle(this)">
                                    <input type="radio" name="gender" value="母" class="hidden"> 母
                                </label>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-brand-light ml-1">結紮 *</label>
                            <div class="flex gap-2">
                                <label class="option-card flex-1 py-2 rounded-xl flex items-center justify-center gap-1 text-xs font-bold" onclick="app.updateRadioStyle(this)">
                                    <input type="radio" name="ligation" value="是" class="hidden" required> 是
                                </label>
                                <label class="option-card flex-1 py-2 rounded-xl flex items-center justify-center gap-1 text-xs font-bold" onclick="app.updateRadioStyle(this)">
                                    <input type="radio" name="ligation" value="否" class="hidden"> 否
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-2 pt-2 border-t border-brand-primary/10">
                        <label class="text-xs font-bold text-brand-light ml-1">過往病史 *</label>
                        <div class="flex gap-2 mb-2">
                            <label class="option-card flex-1 py-2 rounded-xl flex items-center justify-center gap-1 text-xs font-bold" onclick="app.updateRadioStyle(this); app.toggleInput('medical-input', true)">
                                <input type="radio" name="medicalHistory" value="有" class="hidden"> 有
                            </label>
                            <label class="option-card flex-1 py-2 rounded-xl flex items-center justify-center gap-1 text-xs font-bold" onclick="app.updateRadioStyle(this); app.toggleInput('medical-input', false)">
                                <input type="radio" name="medicalHistory" value="無" class="hidden" > 無
                            </label>
                        </div>
                        <input type="text" id="medical-input" name="medicalDetail" class="input-style hidden" placeholder="請說明過往病史...">
                    </div>

<div class="space-y-3">
                        <label class="text-xs font-bold text-brand-light ml-1">社交狀況 *</label>
                        
                        <div class="space-y-1">
                            <span class="text-[10px] text-brand-primary/80 font-bold ml-1">1. 對人/環境反應 *</span>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="option-card p-3 rounded-xl flex items-center justify-center text-center text-[11px] font-bold leading-tight" onclick="app.updateRadioStyle(this)">
                                    <input type="radio" name="socialAggression" value="有攻擊性" class="hidden" required> 有攻擊性
                                </label>
                                <label class="option-card p-3 rounded-xl flex items-center justify-center text-center text-[11px] font-bold leading-tight" onclick="app.updateRadioStyle(this)">
                                    <input type="radio" name="socialAggression" value="無攻擊性" class="hidden"> 無攻擊性
                                </label>
                            </div>
                        </div>

                        <div class="space-y-1">
                            <span class="text-[10px] text-brand-primary/80 font-bold ml-1">2. 與其他狗狗互動 *</span>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="option-card p-3 rounded-xl flex items-center justify-center text-center text-[11px] font-bold leading-tight" onclick="app.updateRadioStyle(this)">
                                    <input type="radio" name="socialInteraction" value="可與狗玩" class="hidden" required> 可與狗朋友們<br>一起玩耍
                                </label>
                                <label class="option-card p-3 rounded-xl flex items-center justify-center text-center text-[11px] font-bold leading-tight" onclick="app.updateRadioStyle(this)">
                                    <input type="radio" name="socialInteraction" value="不可與狗玩" class="hidden"> 不能與狗朋友們<br>一起玩耍
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-brand-light ml-1">寵物美容性情與攻擊性評估 *</label>
                        <div class="space-y-2">
                            <label class="option-card p-3 rounded-xl flex items-start gap-3 cursor-pointer group" onclick="app.updateRadioStyle(this)">
                                <input type="radio" name="temperament" value="天使寶寶" class="hidden" required>
                                <div class="w-2 h-2 rounded-full bg-brand-primary mt-1.5 shrink-0 group-[.selected]:bg-brand-dark"></div>
                                <div>
                                    <span class="text-xs font-bold text-brand-text block">天使寶寶</span>
                                    <span class="text-[10px] text-brand-light">個性溫和，無任何攻擊紀錄，也不怕生。</span>
                                </div>
                            </label>
                            
                            <label class="option-card p-3 rounded-xl flex items-start gap-3 cursor-pointer group" onclick="app.updateRadioStyle(this)">
                                <input type="radio" name="temperament" value="有點緊張" class="hidden">
                                <div class="w-2 h-2 rounded-full bg-brand-primary mt-1.5 shrink-0 group-[.selected]:bg-brand-dark"></div>
                                <div>
                                    <span class="text-xs font-bold text-brand-text block">有點緊張</span>
                                    <span class="text-[10px] text-brand-light">膽小怕生，可能會低吼或閃躲，但未曾咬人。</span>
                                </div>
                            </label>

                            <label class="option-card p-3 rounded-xl flex items-start gap-3 cursor-pointer group border-l-4 border-l-transparent hover:border-l-red-400" onclick="app.updateRadioStyle(this)">
                                <input type="radio" name="temperament" value="恰北北/護主" class="hidden">
                                <div class="w-2 h-2 rounded-full bg-red-400 mt-1.5 shrink-0"></div>
                                <div>
                                    <span class="text-xs font-bold text-red-700 block">恰北北 / 護主</span>
                                    <span class="text-[10px] text-brand-light">對於特定部位敏感，或看到陌生人/狗貓會兇，曾有攻擊或試圖咬人紀錄。</span>
                                    <span class="text-[10px] font-bold text-red-500 block mt-1 bg-red-50 px-2 py-1 rounded">⚠️ 請務必告知讓我們做好防護準備</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="space-y-2 pt-2 border-t border-brand-primary/10">
                        <label class="text-xs font-bold text-brand-light ml-1">晶片號碼 *</label>
                        <div class="grid grid-cols-3 gap-2 mb-2">
                             <label class="option-card py-2 rounded-xl flex items-center justify-center text-[10px] font-bold" onclick="app.updateRadioStyle(this); app.toggleInput('chip-input', true)">
                                <input type="radio" name="chipStatus" value="有晶片" class="hidden" required> 有晶片
                            </label>
                            <label class="option-card py-2 rounded-xl flex items-center justify-center text-[10px] font-bold" onclick="app.updateRadioStyle(this); app.toggleInput('chip-input', false)">
                                <input type="radio" name="chipStatus" value="有晶片(號碼不詳)" class="hidden"> 有晶片<br>(號碼不詳)
                            </label>
                            <label class="option-card py-2 rounded-xl flex items-center justify-center text-[10px] font-bold" onclick="app.updateRadioStyle(this); app.toggleInput('chip-input', false)">
                                <input type="radio" name="chipStatus" value="無晶片" class="hidden"> 無晶片
                            </label>
                        </div>
                        <input type="text" id="chip-input" name="chipId" class="input-style hidden" placeholder="請輸入完整晶片號碼">
                    </div>
                </section>

                <section class="glass-card p-6 border border-brand-primary/20 bg-white/60">
                    <h3 class="text-sm font-bold flex items-center gap-2 text-brand-dark mb-4">
                        <div class="w-1.5 h-1.5 bg-brand-primary rounded-full"></div> 服務項目與計價
                    </h3>
                    
<div class="grid grid-cols-2 gap-3 mb-3">
                        <label class="option-card relative p-4 rounded-2xl flex flex-col items-center justify-center gap-2 text-center h-32 group">
                            <input type="radio" name="mainService" value="精緻洗澡洗+護" class="absolute opacity-0 w-full h-full cursor-pointer" required onchange="app.updateServiceUI()">
                            <i data-lucide="droplets" class="w-8 h-8 text-brand-primary group-hover:scale-110 transition-transform"></i>
                            <div>
                                <h4 class="text-sm font-bold text-brand-text">精緻洗護</h4>
                                <p class="text-[10px] text-brand-light mt-1 leading-tight">二次洗護、剪指甲、清耳朵、剃雜毛、肛門腺、臉部整理</p>
                            </div>
                        </label>

                        <label class="option-card relative p-4 rounded-2xl flex flex-col items-center justify-center gap-2 text-center h-32 group">
                            <input type="radio" name="mainService" value="精緻造型剪毛" class="absolute opacity-0 w-full h-full cursor-pointer" onchange="app.updateServiceUI()">
                            <i data-lucide="scissors" class="w-8 h-8 text-brand-primary group-hover:scale-110 transition-transform"></i>
                            <div>
                                <h4 class="text-sm font-bold text-brand-text">精緻修剪</h4>
                                <p class="text-[10px] text-brand-light mt-1 leading-tight">精緻洗護 + 造型修剪</p>
                            </div>
                        </label>
                    </div>

                    <div class="mb-6 space-y-3">
                        <label class="option-card relative p-3 rounded-xl flex items-center justify-center gap-2 text-center group">
                            <input type="checkbox" name="otherServiceAddon" id="otherServiceAddon" class="absolute opacity-0 w-full h-full cursor-pointer" onchange="app.toggleOtherInput(this.checked)">
                            <span class="text-sm font-bold text-brand-text">其他項目</span>
                            <i data-lucide="plus-circle" class="w-4 h-4 text-brand-primary"></i>
                        </label>

                        <div id="other-input-container" class="hidden animate-fade-in">
                            <input type="text" name="otherServiceDetail" id="otherServiceDetail" class="input-style bg-white border-brand-primary/50" placeholder="請輸入加點的服務內容...">
                        </div>
                    </div>

                    <div class="space-y-4 mb-6">
                        <h4 class="text-xs font-bold text-brand-text flex items-center gap-1">
                            <i data-lucide="sparkles" class="w-3 h-3 text-brand-primary"></i> 升級 SPA
                        </h4>

                        <div id="dog-spa-list" class="hidden animate-fade-in">
                            <div class="bg-white/40 backdrop-blur-sm border border-brand-primary/30 rounded-2xl overflow-hidden shadow-sm">
                                <div class="bg-brand-primary/5 p-4 border-b border-brand-primary/10 space-y-3">
                                    <div class="flex items-center gap-2">
                                        <span class="bg-brand-primary text-white text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm">狗狗專屬</span>
                                        <span class="text-xs font-bold text-brand-text">奢華護理方案</span>
                                    </div>
                                    
                                    <div class="space-y-2 pl-1">
                                        <div class="flex items-start gap-2">
                                            <span class="text-[11px] font-black text-brand-primary shrink-0 mt-0.5 border border-brand-primary/30 px-1.5 rounded bg-white">基礎</span>
                                            <p class="text-[11px] text-brand-dark leading-relaxed">
                                                使用 <span class="font-bold text-brand-text">日本製 ZOIC 胺基酸植萃洗+護</span>。
                                            </p>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <span class="text-[11px] font-black text-white shrink-0 mt-0.5 border border-brand-primary bg-brand-primary px-1.5 rounded">升級</span>
                                            <p class="text-[11px] text-brand-dark leading-relaxed">
                                                想給寶貝更進階的服務？<br>可於下方加購 <span class="font-bold text-brand-text">奢華 SPA 服務</span>。
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-3 grid grid-cols-1 gap-2 bg-white/20" id="dog-spa-container"></div>
                            </div>
                        </div>

                        <div id="cat-spa-list" class="hidden animate-fade-in">
                            <div class="bg-white/40 backdrop-blur-sm border border-brand-primary/30 rounded-2xl overflow-hidden shadow-sm">
                                <div class="bg-[#E6CCCA]/20 p-4 border-b border-[#E6CCCA]/30 space-y-3">
                                    <div class="flex items-center gap-2">
                                        <span class="bg-brand-secondary text-brand-text text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm">貓咪專屬</span>
                                        <span class="text-xs font-bold text-brand-text">奢華護理方案</span>
                                    </div>

                                    <div class="space-y-2 pl-1">
                                        <div class="flex items-start gap-2">
                                            <span class="text-[11px] font-black text-brand-secondary shrink-0 mt-0.5 border border-brand-secondary px-1.5 rounded bg-white">基礎</span>
                                            <p class="text-[11px] text-brand-dark leading-relaxed text-justify">
                                                使用 <span class="font-bold text-brand-text">日本 ZOIC 貓咪沙龍 SPA</span><br>
                                                <span class="text-[10px] text-brand-light block mt-0.5">(含木天蓼萃取，能讓貓咪愉悅放鬆)。</span>
                                            </p>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <span class="text-[11px] font-black text-brand-text shrink-0 mt-0.5 border border-brand-secondary bg-brand-secondary px-1.5 rounded">升級</span>
                                            <p class="text-[11px] text-brand-dark leading-relaxed text-justify">
                                                想給寶貝 <span class="font-bold text-brand-text">義大利進階沙龍洗護</span><br>
                                                可於下方加購 <span class="font-bold text-brand-text">奢華 SPA 服務</span>。
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-3 grid grid-cols-1 gap-2 bg-white/20" id="cat-spa-container"></div>
                            </div>
                        </div>

<div class="bg-white/60 border border-brand-primary/30 rounded-xl p-5 space-y-4 shadow-sm mt-4">
                            
<div id="upgrade-row" class="hidden flex justify-between items-center text-xs animate-fade-in pb-2 mb-2 border-b border-brand-primary/10">
                                <span class="font-bold flex items-center gap-1 text-brand-dark">
                                    <i data-lucide="sparkles" class="w-3 h-3 text-brand-primary"></i> [升級項目] 小計
                                </span>
                                <span id="upgradeTotalDisplay" class="font-mono font-bold text-brand-text text-sm">$0</span>
                            </div>

                            <div class="space-y-1">
                                <label class="text-xs font-bold text-brand-dark ml-1">基礎報價 (由店員告知後填寫) *</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 text-brand-light text-xs font-bold">$</span>
<input type="number" id="basePrice" class="input-style pl-7 py-2 font-bold text-brand-text" placeholder="請輸入基礎金額" oninput="app.calculateTotal()" required>
                                </div>
                                <p class="text-[10px] text-red-500 font-bold bg-red-50 border border-red-100 px-2 py-1.5 rounded-lg flex items-start gap-1">
                                    <i data-lucide="alert-circle" class="w-3 h-3 shrink-0 mt-0.5"></i>
                                    此金額為基礎報價，若現場發現嚴重打結、寄生蟲等狀況，將另行告知加價。
                                </p>
                            </div>

                            <div class="h-px bg-brand-primary/20 w-full border-t border-dashed border-brand-primary/30"></div>

                            <div class="flex justify-between items-end">
                                <span class="text-sm font-bold text-brand-dark">預估總金額</span>
                                <span id="totalPriceDisplay" class="text-2xl font-black text-brand-text">$0</span>
                            </div>
                        </div>                    
                        <div class="space-y-4 pt-4 border-t border-brand-primary/10">
                            <h4 class="text-xs font-bold text-brand-text flex items-center gap-1">
                                <i data-lucide="alert-circle" class="w-3 h-3 text-brand-primary"></i> 特殊服務
                            </h4>

                            <label class="option-card p-4 rounded-xl flex items-center gap-3 cursor-pointer group transition-all" onclick="app.toggleMatting(this)">
                                <input type="checkbox" name="mattingSuspected" class="accent-brand-primary w-4 h-4">
                                <div class="flex-1">
                                    <span class="text-sm font-bold text-brand-text flex items-center gap-2">
                                        疑似有打結 
                                        <span class="text-[10px] font-normal text-brand-light bg-brand-primary/10 px-2 rounded-full">需現場評估</span>
                                    </span>
                                    <span class="text-[11px] text-brand-primary font-bold mt-0.5 block">現場評估拆結費用 300元～2000元</span>
                                </div>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-brand-light transition-transform duration-300" id="matting-arrow"></i>
                            </label>

                            <div id="matting-details" class="hidden transition-all duration-300 ease-in-out">
                                <div class="bg-white/60 rounded-xl border border-brand-primary/20 p-4 space-y-3 relative">
                                    <div class="space-y-4">
                                        <div class="space-y-2">
                                            <h5 class="text-xs font-bold text-brand-dark border-l-4 border-brand-primary pl-2">毛髮打結處理方式（請擇一勾選）</h5>
                                            <p class="text-[11px] text-brand-light leading-relaxed text-justify">
                                                如毛孩於美容過程中發現有毛髮打結、糾結或毛球情形，飼主同意由本店依下列方式處理，並自行勾選確認：
                                            </p>
                                        </div>

                                        <div class="space-y-3">
                                            <label class="block p-3 rounded-lg border border-brand-primary/10 bg-white/80 cursor-pointer hover:border-brand-primary/50 transition-colors">
                                                <div class="flex items-start gap-3">
                                                    <input type="radio" name="mattingChoice" value="拆結處理" class="mt-1 accent-brand-primary shrink-0 w-4 h-4">
                                                    <div class="space-y-1">
                                                        <span class="text-xs font-bold text-brand-text block">方案一 | 拆結處理 (需另計費)</span>
                                                        <p class="text-[10px] text-brand-light leading-relaxed text-justify opacity-80">
                                                            本人同意由美容師進行拆結處理，並願意支付拆結費用。本人了解拆結過程中可能產生毛髮斷裂、毛量減少或外觀不均屬正常情況，並同意不因此提出異議。<br>
                                                            <span class="text-red-500 font-bold">拆結費用為 NT$300～NT$2000不等</span>，將依毛髮打結之嚴重程度、範圍及實際施作時間評估。<br>
                                                            本店將於美容開始前說明並當場報價，經飼主同意後才會進行，本人了解並同意本店不會於美容過程中臨時加價或就地起價。
                                                        </p>
                                                    </div>
                                                </div>
                                            </label>

                                            <label class="block p-3 rounded-lg border border-brand-primary/10 bg-white/80 cursor-pointer hover:border-brand-primary/50 transition-colors">
                                                <div class="flex items-start gap-3">
                                                    <input type="radio" name="mattingChoice" value="直接修剪" class="mt-1 accent-brand-primary shrink-0 w-4 h-4">
                                                    <div class="space-y-1">
                                                        <span class="text-xs font-bold text-brand-text block">方案二 | 不拆結，直接修剪</span>
                                                        <p class="text-[10px] text-brand-light leading-relaxed text-justify opacity-80">
                                                            本人不願意支付拆結費用，同意美容師於遇到打結時，直接修剪糾結毛髮。<br>
                                                            本人了解修剪後外觀可能出現長短不一、局部稀疏或不平整之情形，並表示可接受，不因此提出異議。
                                                        </p>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>

                                        <div class="bg-brand-bg/80 p-3 rounded-lg space-y-2 border border-brand-primary/10">
                                            <div class="space-y-1">
                                                <span class="text-[10px] font-bold text-brand-dark block">補充說明一：</span>
                                                <p class="text-[10px] text-brand-light leading-relaxed text-justify">
                                                    飼主了解並同意，實際處理方式仍將由美容師依毛孩當下毛況、皮膚狀態及安全考量，進行專業判斷並採取最適合之處理方式。
                                                </p>
                                            </div>
                                            <div class="space-y-1">
                                                <span class="text-[10px] font-bold text-brand-dark block">補充說明二：</span>
                                                <p class="text-[10px] text-brand-light leading-relaxed text-justify">
                                                    如美容師評估毛髮打結情況已嚴重影響毛孩皮膚健康，或在處理過程中可能造成明顯疼痛、高度壓力、受傷風險，基於動物福利與安全考量，本店保有拒絕繼續美容或中止服務之權利。<br>
                                                    飼主了解並同意，上述情況不視為本店違約，並願意配合後續適當處理建議（如直接剃光）。
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4 pt-4 border-t border-brand-primary/10">
                            <h4 class="text-xs font-bold text-brand-text flex items-center gap-1">
                                <i data-lucide="clock" class="w-3 h-3 text-brand-primary"></i> 逾時與安置費用說明
                            </h4>
                            
                            <div class="bg-[#FFF9F2] border border-[#E6CCCA]/50 rounded-xl p-4 relative overflow-hidden">
                                <ul class="space-y-3">
                                    <li class="flex items-center gap-2">
                                        <span class="bg-[#8A7B70] text-white text-[10px] px-2 py-0.5 rounded font-bold shrink-0">1小時內</span>
                                        <span class="text-xs text-brand-text font-bold">免收費。</span>
                                    </li>
                                    <li class="flex items-center gap-2">
                                        <span class="bg-[#C7B299] text-white text-[10px] px-2 py-0.5 rounded font-bold shrink-0">超過1小時</span>
                                        <span class="text-xs text-brand-text font-bold">以 1 小時計算 ($200/hr)。</span>
                                    </li>
                                    <li class="pt-2 mt-1">
                                        <div class="bg-red-50 border border-red-200 rounded-lg p-3 shadow-sm">
                                            <div class="flex items-start gap-2">
                                                <i data-lucide="alert-triangle" class="w-4 h-4 text-red-500 shrink-0 mt-0.5"></i>
                                                <p class="text-[11px] text-red-800 leading-relaxed text-justify font-bold">
                                                    超過 1 小時以上，本店將先行 <span class="bg-red-200 text-red-900 px-1 rounded">安置犬貓</span> (提供水、飼料)，屆時將收取必要之安置費用。
                                                </p>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="space-y-4 pt-4 border-t border-brand-primary/10">                        
<div class="space-y-4 pt-4 border-t border-brand-primary/10">
                            <h4 class="text-xs font-bold text-brand-text flex items-center gap-1">
                                <i data-lucide="wallet" class="w-3 h-3 text-brand-primary"></i> 支付方式 *
                            </h4>
                            <div class="grid grid-cols-2 gap-3">
                                <label class="option-card p-3 rounded-xl flex items-center justify-center gap-2 cursor-pointer group" onclick="app.updateRadioStyle(this)">
                                    <input type="radio" name="paymentMethod" value="現金" class="hidden" required>
                                    <div class="w-6 h-6 rounded-full bg-brand-bg flex items-center justify-center text-brand-light group-[.selected]:bg-brand-primary group-[.selected]:text-white transition-colors">
                                        <i data-lucide="banknote" class="w-3.5 h-3.5"></i>
                                    </div>
                                    <span class="text-sm font-bold text-brand-text">現金支付</span>
                                </label>

                                <label class="option-card p-3 rounded-xl flex items-center justify-center gap-2 cursor-pointer group" onclick="app.updateRadioStyle(this)">
                                    <input type="radio" name="paymentMethod" value="LINE Pay" class="hidden">
                                    <img src="linepay.png" alt="LINE Pay" class="h-5 w-auto object-contain">
                                </label>
                            </div>
                        </div>
                    </div>
                </section>

<section class="glass-card p-6 space-y-4 bg-white/80">
                    <h3 class="text-sm font-bold flex items-center gap-2 text-brand-dark border-b border-brand-primary/10 pb-2">
                        <div class="w-1.5 h-1.5 bg-brand-secondary rounded-full"></div> 契約條款與簽署
                    </h3>
                    
                    <div onclick="app.toggleTermsModal(true,'general')" class="w-full bg-white border border-brand-primary/30 rounded-2xl p-4 flex items-center justify-between cursor-pointer shadow-sm active:scale-98 transition-transform group">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-brand-primary/10 flex items-center justify-center text-brand-primary group-hover:bg-brand-primary group-hover:text-white transition-colors">
                                <i data-lucide="file-text" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-brand-text">美容服務契約條款 *</h4>
                                <p class="text-[10px] text-brand-light">點擊開啟全螢幕詳細閱讀</p>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-brand-light/50"></i>
                    </div>

                    <div id="risk-warning-banner" class="hidden w-full bg-[#fef2f2] border border-[#fee2e2] rounded-2xl p-4 flex items-center justify-between cursor-pointer shadow-sm animate-fade-in active:scale-98 transition-transform group mt-3" onclick="app.toggleTermsModal(true, 'risk')">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-[#fee2e2] flex items-center justify-center text-[#dc2626] group-hover:bg-[#dc2626] group-hover:text-white transition-colors">
                                <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-black text-[#991b1b]">高風險寵物美容風險告知</h4>
                                <p class="text-[10px] text-[#f87171] font-bold">檢測到毛孩屬於高風險族群，請務必詳閱</p>
                            </div>
                        </div>
                        <span class="bg-[#fee2e2] text-[#991b1b] text-[10px] font-black px-3 py-1.5 rounded-full whitespace-nowrap">務必詳閱</span>
                    </div>

<div class="space-y-3 pt-2">
                        
                        <div id="risk-checkbox-container" class="hidden animate-fade-in">
                            <label class="flex items-start gap-3 p-3 cursor-pointer rounded-xl bg-[#fef2f2] border border-[#fee2e2] hover:bg-red-50 transition-colors shadow-sm">
                                <input type="checkbox" id="risk-checkbox" class="w-5 h-5 accent-red-500 shrink-0 mt-0.5">
                                <span class="text-xs font-bold text-[#991b1b] leading-relaxed">
                                    本人已詳閱契約內容，並同意承擔高風險服務之相關責任。
                                </span>
                            </label>
                        </div>

                        <div id="normal-checkbox-container" class="animate-fade-in">
                            <label class="flex items-center gap-2 p-2 cursor-pointer rounded-lg hover:bg-black/5 transition-colors">
                                <input type="checkbox" id="agreement" class="w-4 h-4 accent-brand-primary shrink-0" required>
                                <span class="text-xs font-bold text-brand-text">本人已詳閱並同意以上契約內容</span>
                            </label>
                        </div>
<div class="bg-brand-bg/50 p-5 rounded-2xl border border-brand-primary/20 space-y-3">
                        <h4 class="text-sm font-bold text-brand-dark flex items-center gap-2 border-b border-brand-primary/10 pb-2 mb-1">
                            <i data-lucide="info" class="w-4 h-4 text-brand-primary"></i> 乙方業者資訊
                        </h4>
                        <div class="space-y-2 text-xs leading-relaxed text-brand-light">
                            <p><strong class="text-brand-text">店家名稱：</strong>麥克諾尼寵物沙龍</p>
                            <p><strong class="text-brand-text">聯絡電話：</strong>02-27129404</p>
                            <p><strong class="text-brand-text">店家地址：</strong>台北市松山區敦化北路222巷20號</p>
                            <p><strong class="text-brand-text">營業時間：</strong>9:00-18:00 (每週三、週日公休)</p>
                            
                            <div class="mt-3 pt-3 border-t border-brand-primary/10">
                                <p class="font-bold text-brand-text mb-1 flex items-center gap-1">
                                    <i data-lucide="ambulance" class="w-3 h-3"></i> 特約緊急送醫場所：
                                </p>
                                <p class="pl-4">上群動物醫院</p>
                                <p class="pl-4 text-[10px]">地址：台北市中山區南京東路三段215號</p>
                                <p class="pl-4 text-[10px]">電話：(02)2775-3007、(02)2751-4182</p>
                            </div>
                        </div>
                    </div>
                        <div class="space-y-1 pt-2">
                            <label class="text-xs font-bold text-brand-dark flex items-center gap-1 ml-1">
                                <i data-lucide="pen-tool" class="w-3 h-3"></i> 數位簽名 *
                            </label>

                            <div id="signature-trigger" onclick="app.signaturePad.open()" class="w-full h-24 rounded-xl border-2 border-dashed border-brand-primary/30 bg-brand-bg/30 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-brand-primary/5 hover:border-brand-primary transition-all group">
                                <span class="text-xs font-bold text-brand-light group-hover:text-brand-text flex items-center gap-1">
                                    <i data-lucide="edit-3" class="w-3 h-3"></i> 點擊簽名
                                </span>
                                <span class="text-[10px] text-brand-primary/60">系統將開啟全螢幕簽名板</span>
                            </div>
                            
                            <div id="signature-result" class="hidden relative group animate-fade-in">
                                <div class="w-full bg-white border border-brand-primary/20 rounded-xl p-2 relative overflow-hidden shadow-sm">
                                    <button type="button" onclick="app.signaturePad.reset()" class="absolute top-2 right-2 p-1.5 bg-gray-50 text-gray-400 hover:bg-red-50 hover:text-red-500 rounded-lg transition-colors z-20">
                                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                    </button>
                                    
                                    <div class="flex justify-center h-16 relative z-10">
                                        <img id="sig-image" src="" alt="您的簽名" class="h-full object-contain">
                                    </div>
                                    <div class="flex items-center justify-between gap-2 mt-2 pt-2 border-t border-dashed border-gray-100">
                                        <div class="bg-[#06C755]/10 text-[#06C755] px-1.5 py-0.5 rounded text-[10px] font-black flex items-center gap-1">
                                            <i data-lucide="check-circle" class="w-3 h-3"></i> 已簽署
                                        </div>
                                        <span id="sig-timestamp" class="text-[10px] text-gray-400 font-mono">--:--</span>
                                    </div>
                                </div>
                                <input type="hidden" name="signatureData" id="signatureData" required>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-brand-text text-white py-3.5 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all hover:bg-brand-dark mt-2">
                        <i data-lucide="send" class="w-4 h-4"></i> 確認送出預約
                    </button>
                </section>
            </form>
        </div>
    </main>

    <div id="signature-modal" class="fixed inset-0 z-50 bg-white hidden flex-col">
        <div class="bg-brand-bg px-4 py-3 flex justify-between items-center shadow-sm shrink-0">
            <h3 class="font-bold text-brand-text">請在下方簽名</h3>
            <button type="button" onclick="app.signaturePad.close()" class="p-2 text-brand-light hover:text-brand-dark">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <div class="flex-1 relative bg-gray-50 touch-none overflow-hidden" id="canvas-container">
            <canvas id="sig-canvas" class="absolute top-0 left-0 w-full h-full cursor-crosshair signature-pad"></canvas>
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-20 text-4xl font-bold text-gray-300 select-none">
                在此區域書寫
            </div>
        </div>

        <div class="p-4 bg-white border-t border-brand-primary/10 flex gap-3 shrink-0 pb-8">
            <button type="button" onclick="app.signaturePad.clear()" class="flex-1 py-3 rounded-xl border border-brand-primary text-brand-primary font-bold">清除重寫</button>
            <button type="button" onclick="app.signaturePad.save()" class="flex-1 py-3 rounded-xl bg-brand-text text-white font-bold shadow-lg">確認簽名</button>
        </div>
    </div>

<script>
        // PWA 自動更新腳本 (sw.js)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js?v=7').then(reg => {
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                window.location.reload();
                            }
                        };
                    };
                });
            });
        }

        const app = {};

        // --- 1. 確保頁面與 Supabase 載入完成後再執行主要邏輯 ---
        window.addEventListener('load', () => {
            
            // 初始化 Supabase
            if (window.supabase) {
                const SUPABASE_URL = 'https://sudsagtksfdgkvxjtcze.supabase.co'; 
                const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN1ZHNhZ3Rrc2ZkZ2t2eGp0Y3plIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNDc3ODIsImV4cCI6MjA4NDgyMzc4Mn0.J_ZH5rA2uSG2m5pt76-7l95etd9reB4pePQDZs5GZMI'; 
                window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } else {
                console.error("Supabase library failed to load.");
                alert("系統載入失敗，請重新整理頁面。");
                return;
            }

            // Toast 工具
            const toast = {
                container: null,
                init() { this.container = document.getElementById('toast-container'); },
                show(message, type = 'success', title = '') {
                    if (!this.container) this.init();
                    const toastEl = document.createElement('div');
                    toastEl.className = `toast ${type}`;
                    
                    let iconColor = 'text-brand-primary';
                    let defaultTitle = '通知';
                    let iconName = 'info';

                    switch(type) {
                        case 'success':
                            iconColor = 'text-green-500';
                            defaultTitle = '成功';
                            iconName = 'check-circle-2';
                            break;
                        case 'error':
                            iconColor = 'text-red-500';
                            defaultTitle = '錯誤';
                            iconName = 'alert-circle';
                            break;
                        case 'warning':
                            iconColor = 'text-amber-500';
                            defaultTitle = '注意';
                            iconName = 'alert-triangle';
                            break;
                    }

                    const finalTitle = title || defaultTitle;
                    
                    toastEl.innerHTML = `
                        <i data-lucide="${iconName}" class="toast-icon ${iconColor}"></i>
                        <div class="toast-content">
                            <div class="toast-title">${finalTitle}</div>
                            <div class="toast-message">${message}</div>
                        </div>
                    `;
                    
                    this.container.appendChild(toastEl);
                    lucide.createIcons();
                    
                    setTimeout(() => {
                        toastEl.classList.add('removing');
                        setTimeout(() => toastEl.remove(), 300);
                    }, 3000);
                }
            };

            // --- 2. 將原本的 app 物件內容賦值給外部的 app ---
            // 這樣外部 HTML 的 onclick 就能呼叫到這些方法了
            Object.assign(app, {
                state: {
                    lineConfirmed: false,
                    currentView: 'home'
                },

                data: {
                    bannerImages: [
                        'line_oa_chat_260116_170310_group_0.jpg',
                        'line_oa_chat_260116_170310_group_1.jpg',
                        'line_oa_chat_260116_170310_group_2.jpg',
                        'line_oa_chat_260116_170310_group_3.jpg',
                        'line_oa_chat_260116_170310_group_4.jpg',
                        'line_oa_chat_260116_170310_group_5.jpg',
                        'line_oa_chat_260116_170310_group_6.jpg',
                        'line_oa_chat_260116_170310_group_7.jpg',
                        'line_oa_chat_260116_170322.jpg',
                    ],
                    
                    productList: [
                        { title: "紅寶系列", sub: "進階美容專用", img: "line_oa_chat_260116_170310_group_0.jpg" },
                        { title: "魚子醬系列", sub: "頂級精華修復", img: "line_oa_chat_260116_170310_group_1.jpg" },
                        { title: "艾詩貝客製化皮膚調理", sub: "礦物元素SPA", img: "line_oa_chat_260116_170310_group_2.jpg" },
                        { title: "RENADOG", sub: "韓國專業造型剪毛洗護SPA", img: "line_oa_chat_260116_170310_group_3.jpg" },
                        { title: "SKIMO 頂級奈米護膚", sub: "日系新感覺保濕", img: "line_oa_chat_260116_170310_group_4.jpg" },
                        { title: "Furmake EX", sub: "專業蓬鬆洗劑", img: "line_oa_chat_260116_170310_group_5.jpg" },
                        { title: "ZOIC Cut-X", sub: "日本職人專用造型噴霧", img: "line_oa_chat_260116_170310_group_6.jpg" },
                        { title: "ZOIC炭酸泉", sub: "深層清潔美肌", img: "line_oa_chat_260116_170310_group_7.jpg" }
                    ],
                    
                    dogSpas: [
                        { name: '日本 ZOIC 碳酸 SPA', price: '+199' },
                        { name: '日本頂級 SKIMO 奈米 SPA', price: '+399' },
                        { name: '義大利魚子醬 SPA', price: '+399' },
                        { name: '義大利柑橘廢毛SPA', price: '+399' },
                        { name: '義大利活化抗老百香果SPA', price: '+399' },
                        { name: '義大利客製化皮膚調理 SPA', price: '+399~599' },
                        { name: '美國去油護理服務/除廢毛 SPA', price: '+300~500' },

                    ],
                    
                    catSpas: [
                        { name: '義大利客製化皮膚調理 SPA', price: '+399' },
                        { name: '義大利魚子醬 SPA', price: '+399' },
                        { name: '義大利柑橘/百香果代謝廢毛 SPA', price: '+399' },
                        { name: '日本 ZOIC 碳酸 SPA', price: '+199' },
                        { name: '日本頂級 SKIMO 奈米 SPA', price: '+399' },
                        { name: '美國去油護理服務/除廢毛 SPA', price: '+300~500' },
                    ]
                },

// 搜尋 init() { ... } 並替換成這個版本
init() {
    lucide.createIcons();
    toast.init();
    this.renderBanner();
    this.renderProducts();
    this.loadDynamicPrices();
    
    // 1. 處理初始載入的 Hash
    const hash = window.location.hash.replace('#', '');
    if(hash) this.switchView(hash, false); // false 代表不要重複推入歷史紀錄
    
    // 2. [新增] 監聽瀏覽器的「上一頁/下一頁」按鈕事件
    window.addEventListener('popstate', () => {
        const currentHash = window.location.hash.replace('#', '');
        // 如果 Hash 變成空的，代表回到首頁
        this.switchView(currentHash || 'home', false);
    });
document.querySelectorAll('input[required], textarea[required], select[required]').forEach(el => {
    el.addEventListener('blur', () => {
        if (!el.checkValidity()) {
            this.showFieldError(el, '此欄位必填');
                   } else {
            this.clearFieldError(el); 
        }
    });
});
// ====== 即時驗證 + 離開欄位顯示錯誤 ======
const regexMap = {
    phone: /^09\d{8}$/,
    emergencyPhone: /^09\d{8}$/,
    ownerId: /^[A-Z][12]\d{8}$/
};

// 1. 輸入時：若格式正確就清除錯誤
document.querySelectorAll('input, textarea, select').forEach(el => {
    el.addEventListener('input', () => {
        if (el.checkValidity()) this.clearFieldError(el);
    });
});

// 2. 離開欄位時：如果格式錯誤就顯示紅字
Object.keys(regexMap).forEach(id => {
    const input = document.getElementById(id);
    if (!input) return;

    input.addEventListener('blur', () => {
        const value = input.value.trim();
        if (value === '') return;

        if (!regexMap[id].test(value)) {
            this.showFieldError(input, '格式錯誤');
        } else {
            this.clearFieldError(input);
        }
    });
});
    this.signaturePad.init();
},

async loadDynamicPrices() {
                    try {
                        const { data, error } = await window.supabaseClient
                            .from('price_settings')
                            .select('*')
                            .order('id', { ascending: true });

                        if (error) throw error;

                        // 將資料分配給狗狗跟貓咪
                        const dogList = data.filter(i => i.category === 'dog_spa');
                        const catList = data.filter(i => i.category === 'cat_spa');

                        // 渲染列表
                        this.renderSpaList('dog-spa-container', dogList);
                        this.renderSpaList('cat-spa-container', catList);
                        
                        console.log('動態價目載入成功');
                    } catch (err) {
                        console.error('載入價目失敗，使用預設值:', err);
                        // 如果資料庫壞了，才讀取原本寫死的 data.dogSpas
                        this.renderSpaList('dog-spa-container', this.data.dogSpas);
                        this.renderSpaList('cat-spa-container', this.data.catSpas);
                    }
                },
                renderBanner() {
                    const bannerContainer = document.getElementById('banner-container');
                    const allImages = [...this.data.bannerImages, ...this.data.bannerImages, ...this.data.bannerImages, ...this.data.bannerImages];
                    bannerContainer.innerHTML = allImages.map(src => 
                        `<img src="${src}" onerror="this.style.display='none'" class="h-full w-[10%] object-cover" alt="banner">`
                    ).join('');
                },

                renderProducts() {
                    const productContainer = document.getElementById('product-list');
                    productContainer.innerHTML = this.data.productList.map(item => `
                        <div class="bg-white p-3 rounded-2xl shadow-sm space-y-3">
                          <div class="aspect-square rounded-xl overflow-hidden bg-[#fafafa] flex items-center justify-center">
                            <img src="${item.img}" onerror="this.src='https://placehold.co/150x150?text=Product'" class="max-w-full max-h-full object-contain p-1" alt="${item.title}" />
                          </div>
                          <div class="px-1 text-center">
                            <h4 class="text-xs font-bold text-brand-text leading-tight">${item.title}</h4>
                            <p class="text-[10px] text-brand-light leading-tight">${item.sub}</p>
                          </div>
                        </div>
                    `).join('');
                },

                renderSpaList(id, list) {
                    const container = document.getElementById(id);
                    
                    // 1. 先清空容器
                    container.innerHTML = '';
                    
                    // 2. 生成 JS 列表中的項目 (例如: 碳酸 SPA、魚子醬 SPA...)
                    list.forEach(spa => {
                        const label = document.createElement('label');
                        label.className = 'flex items-center justify-between p-3 rounded-xl border border-transparent hover:bg-white/80 bg-white/40 transition-all cursor-pointer';
                        label.innerHTML = `
                            <div class="flex items-center gap-3">
                                <input type="checkbox" name="spaUpgrades" value="${spa.name}" data-price="${spa.price}" onchange="app.calculateTotal()" class="accent-brand-primary">
                                <span class="text-xs font-bold text-brand-text">${spa.name}</span>
                            </div>
                            <span class="text-xs font-bold text-brand-primary">${spa.price}元</span>
                        `;
                        container.appendChild(label);
                    });

                    // 3. 手動新增「刷牙服務」區塊 (含提示文字) - 這段永遠會加在最後
                    const brushLabel = document.createElement('label');
                    brushLabel.className = 'flex items-start gap-3 p-3 rounded-xl border border-brand-primary/20 bg-white/80 transition-all cursor-pointer group hover:bg-white mt-2';
                    brushLabel.innerHTML = `
                        <input type="checkbox" name="spaUpgrades" value="刷牙服務" data-price="+50" onchange="app.calculateTotal()" class="accent-brand-primary mt-1 shrink-0">
                        <div class="flex-1 space-y-1">
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-bold text-brand-text">刷牙服務</span>
                                <span class="text-xs font-bold text-brand-primary">+50元</span>
                            </div>
                            <p class="text-[10px] text-brand-light leading-tight">請自備牙刷、牙膏，若忘記攜帶可以店內購買。</p>
                        </div>
                    `;
                    container.appendChild(brushLabel);
                },


// 搜尋 switchView(viewName) 並替換成這個版本
switchView(viewName, updateHistory = true) { // 多了 updateHistory 參數
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    const target = document.getElementById('view-' + viewName);
    if(target) target.classList.add('active');
    
    window.scrollTo({ top: 0, behavior: 'smooth' });

    const backBtn = document.getElementById('back-btn');
    if (viewName === 'home') {
        backBtn.classList.add('hidden');
        // 只有在主動點擊時才修改歷史紀錄
        if (updateHistory) {
            history.pushState(null, null, ' '); // 清除 hash
        }
    } else {
        backBtn.classList.remove('hidden');
        if (updateHistory) {
            window.location.hash = viewName; // 設定 hash
        }
    }
    
    this.state.currentView = viewName;
},

                toggleLineCheck() {
                    this.state.lineConfirmed = !this.state.lineConfirmed;
                    const btn = document.getElementById('line-check-btn');
                    const icon = document.getElementById('line-check-icon');
                    const text = document.getElementById('line-check-text');

                    if (this.state.lineConfirmed) {
                        btn.className = "w-full flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-bold transition-all duration-300 border bg-[#06C755] text-white border-[#06C755] shadow-lg";
                        icon.className = "w-4 h-4 rounded-full border border-white bg-white/20 flex items-center justify-center";
                        icon.innerHTML = '<i data-lucide="check" size="10" class="w-3 h-3"></i>';
                        text.innerText = "OK！我已加入並傳送貼圖";
                        lucide.createIcons();
                    } else {
                        btn.className = "w-full flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-bold transition-all duration-300 border bg-white text-brand-light border-slate-200";
                        icon.className = "w-4 h-4 rounded-full border border-current flex items-center justify-center";
                        icon.innerHTML = '';
                        text.innerText = "確認：我已完成上述兩步驟";
                    }
                },

                selectSpecies(species, labelEl) {
                    document.querySelectorAll('.option-card input[name="petSpecies"]').forEach(el => {
                        el.parentElement.classList.remove('selected', 'bg-white', 'border-brand-primary', 'shadow-md');
                    });
                    labelEl.classList.add('selected', 'bg-white', 'border-brand-primary', 'shadow-md');
                    labelEl.querySelector('input').checked = true;

                    if (species === '犬') {
                        document.getElementById('dog-spa-list').classList.remove('hidden');
                        document.getElementById('cat-spa-list').classList.add('hidden');
                    } else {
                        document.getElementById('dog-spa-list').classList.add('hidden');
                        document.getElementById('cat-spa-list').classList.remove('hidden');
                    }
                },

                checkRisk(age) {
                    const warningBanner = document.getElementById('risk-warning-banner');
                    const modalRiskContent = document.getElementById('modal-risk-content');
                    const riskContainer = document.getElementById('risk-checkbox-container');
                    const normalContainer = document.getElementById('normal-checkbox-container');
                    const riskInput = document.getElementById('risk-checkbox');
                    const normalInput = document.getElementById('agreement');
                    
                    const ageNum = parseFloat(age);
                    
                    if (!isNaN(ageNum) && (ageNum >= 8 || ageNum <= 1)) {
                        warningBanner.classList.remove('hidden');
                        modalRiskContent.classList.remove('hidden');
                        riskContainer.classList.remove('hidden');
                        normalContainer.classList.add('hidden');
                        riskInput.required = true;
                        normalInput.required = false;
                        normalInput.checked = false;
                        toast.show('檢測為高風險族群，請務必詳閱紅色告知條款', 'warning');
                    } else {
                        warningBanner.classList.add('hidden');
                        modalRiskContent.classList.add('hidden');
                        riskContainer.classList.add('hidden');
                        normalContainer.classList.remove('hidden');
                        riskInput.required = false;
                        riskInput.checked = false;
                        normalInput.required = true;
                    }
                },

                toggleTermsModal(show, type = 'general') {
                    const modal = document.getElementById('terms-modal');
                    const title = document.getElementById('modal-title');
                    const generalContent = document.getElementById('modal-general-content');
                    const riskContent = document.getElementById('modal-risk-content');

                    if (show) {
                        modal.classList.remove('hidden');
                        modal.classList.add('flex');
                        document.body.style.overflow = 'hidden';
                        
                        if (type === 'general') {
                            title.innerText = '美容服務契約條款';
                            generalContent.classList.remove('hidden');
                            riskContent.classList.add('hidden');
                        } else if (type === 'risk') {
                            title.innerText = '高風險風險告知';
                            generalContent.classList.add('hidden');
                            riskContent.classList.remove('hidden');
                        }
                        
                        modal.querySelector('.overflow-y-auto').scrollTop = 0;
                        lucide.createIcons();
                    } else {
                        modal.classList.add('hidden');
                        modal.classList.remove('flex');
                        document.body.style.overflow = '';
                    }
                },
// --- 後台管理員登入檢查 (點擊 Logo 兩次) ---
checkAdminAccess: function() {
    let clickCount = parseInt(sessionStorage.getItem('logoClickCount') || '0');
    
    clickCount++;
    sessionStorage.setItem('logoClickCount', clickCount);

    if (clickCount >= 2) {
        sessionStorage.setItem('logoClickCount', '0'); // 重置計數
        setTimeout(() => {
            window.location.href = 'admin.html'; // 跳轉到後台
        }, 300);
    }
},

                // --- 搜尋舊客功能 (取代原本的 autoFillDemo) ---
                handleSearchOldCustomer: async function() {
                    const phoneInput = document.getElementById('phone');
                    const phone = phoneInput.value.trim();
                    
                    if (!phone || phone.length !== 10) {
                        toast.show('請先輸入有效的手機號碼 (10碼)', 'error');
                        return;
                    }
                    
                    // 顯示按鈕 Loading 狀態
                    const btn = document.querySelector('button[onclick="app.handleSearchOldCustomer()"]');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>';
                    btn.disabled = true;
                    lucide.createIcons();

                    try {
                        // 查詢資料庫中是否有相同手機號碼的客戶
                        const { data, error } = await window.supabaseClient
                            .from('bookings')
                            .select('*')
                            .eq('owner_phone', phone)
                            .order('created_at', { ascending: false });
                        
                        if (error) throw error;
                        
                        if (data && data.length > 0) {
                            // 去重邏輯：如果同一隻寵物有多筆紀錄，只取最新的一筆
                            const uniquePets = {};
                            data.forEach(record => {
                                const name = record.pet_name;
                                if (!uniquePets[name]) {
                                    uniquePets[name] = record;
                                }
                            });
                            
                            // 將物件轉回陣列並渲染選單
                            const petList = Object.values(uniquePets);
                            this.renderPetSelectionModal(petList);
                        } else {
                            toast.show('查無此手機號碼的舊客資料', 'warning');
                        }
                    } catch (error) {
                        console.error('查詢錯誤:', error);
                        toast.show('查詢失敗，請稍後再試', 'error');
                    } finally {
                        // 恢復按鈕狀態
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        lucide.createIcons();
                    }
                },

                // 輔助函數：渲染寵物選擇列表
                renderPetSelectionModal: function(pets) {
                    const modal = document.getElementById('petSelectModal');
                    const container = document.getElementById('petListContainer');
                    const content = document.getElementById('petSelectContent');
                    
                    container.innerHTML = ''; // 清空舊內容

                    pets.forEach(pet => {
                        const btn = document.createElement('button');
                        btn.className = 'w-full text-left p-4 rounded-2xl bg-white border border-brand-primary/10 shadow-sm hover:border-brand-primary hover:shadow-md hover:bg-brand-primary/5 transition-all group relative overflow-hidden';
                        btn.onclick = () => {
                            this.fillFormWithData(pet); // 點擊後填入資料
                            this.closePetSelectModal(); // 關閉彈窗
                            toast.show(`已載入 ${pet.pet_name} 的資料`, 'success');
                        };

                        // 將日期轉成 YYYY/MM/DD 格式
                        const dateObj = new Date(pet.created_at);
                        const dateStr = `${dateObj.getFullYear()}/${(dateObj.getMonth()+1).toString().padStart(2, '0')}/${dateObj.getDate().toString().padStart(2, '0')}`;

                        btn.innerHTML = `
                            <div class="flex items-center justify-between relative z-10">
                                <div>
                                    <span class="block text-lg font-bold text-brand-text group-hover:text-brand-primary transition-colors">${pet.pet_name}</span>
                                    <span class="text-xs text-brand-light">上次服務：${dateStr}</span>
                                </div>
                                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-brand-primary group-hover:text-white transition-colors">
                                    <i data-lucide="arrow-down-to-line" class="w-4 h-4"></i>
                                </div>
                            </div>
                        `;
                        container.appendChild(btn);
                    });

                    // 顯示彈窗
                    modal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // 鎖定背景捲動
                    lucide.createIcons();

                    // 動畫
                    setTimeout(() => {
                        modal.classList.remove('opacity-0');
                        content.classList.remove('scale-95');
                        content.classList.add('scale-100');
                    }, 10);
                },

                // 輔助函數：關閉寵物選擇彈窗
                closePetSelectModal: function() {
                    const modal = document.getElementById('petSelectModal');
                    const content = document.getElementById('petSelectContent');
                    
                    modal.classList.add('opacity-0');
                    content.classList.remove('scale-100');
                    content.classList.add('scale-95');
                    
                    document.body.style.overflow = ''; // 解除鎖定
                    
                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 300);
                },

                // 輔助函數：設定 Radio 按鈕的值
                setRadioValue: function(name, value) {
                    if (!value) return;
                    const radios = document.querySelectorAll(`input[name="${name}"]`);
                    radios.forEach(radio => {
                        if (radio.value === value) {
                            radio.checked = true;
                            // 觸發點擊事件以更新 UI 樣式 (針對 option-card)
                            radio.closest('.option-card')?.click();
                        }
                    });
                },

// 輔助函數：填寫表單資料 (舊客導入)
                fillFormWithData: function(data) {
                    // 0. 自動勾選 Line (舊客視為已加入)
                    this.state.lineConfirmed = true;
                    const btn = document.getElementById('line-check-btn');
                    const icon = document.getElementById('line-check-icon');
                    const text = document.getElementById('line-check-text');
                    btn.className = "w-full flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-bold transition-all duration-300 border bg-[#06C755] text-white border-[#06C755] shadow-lg";
                    icon.className = "w-4 h-4 rounded-full border border-white bg-white/20 flex items-center justify-center";
                    icon.innerHTML = '<i data-lucide="check" size="10" class="w-3 h-3"></i>';
                    text.innerText = "OK！我已加入並傳送貼圖";
                    lucide.createIcons();

                    // 1. 填入飼主資料
                    document.getElementById('phone').value = data.owner_phone || ''; 
                    document.getElementById('ownerName').value = data.owner_name || ''; 
                    document.getElementById('ownerId').value = data.owner_id || ''; 
                    document.getElementById('email').value = data.email || ''; 
                    document.getElementById('address').value = data.address || ''; 
                    document.getElementById('emergencyName').value = data.emergency_name || ''; 
                    document.getElementById('emergencyPhone').value = data.emergency_phone || ''; 
                    document.getElementById('preferredClinic').value = data.preferred_clinic || ''; 

                    // 2. 填入寵物資料
                    document.getElementById('petName').value = data.pet_name || ''; 
                    document.getElementById('breed').value = data.breed || ''; 
                    document.getElementById('weight').value = data.weight || ''; 
                    document.getElementById('ageYear').value = data.age || ''; 
                    
                    // 3. 處理單選項目 (導入歷史習慣)
                    this.setRadioValue('petSpecies', data.pet_species);
                    if (data.pet_species) {
                        const speciesLabel = Array.from(document.querySelectorAll('input[name="petSpecies"]'))
                            .find(i => i.value === data.pet_species)?.parentElement;
                        if(speciesLabel) this.selectSpecies(data.pet_species, speciesLabel);
                    }
                    this.setRadioValue('gender', data.gender); 
                    this.setRadioValue('ligation', data.ligation); 
                    this.setRadioValue('medicalHistory', data.medical_history); 
                    this.setRadioValue('socialAggression', data.social_aggression); 
                    this.setRadioValue('socialInteraction', data.social_interaction); 
                    this.setRadioValue('temperament', data.temperament); 
                    
                    // --- 重寫：晶片狀況導入 ---
                    this.setRadioValue('chipStatus', data.chip_status);
                    const chipInput = document.getElementById('chip-input');
                    chipInput.value = data.chip_id || '';
                    if(data.chip_status === '有晶片') {
                        this.toggleInput('chip-input', true);
                    } else {
                        this.toggleInput('chip-input', false);
                    }

                    // 4. 強制重置本次消費相關欄位 (不導入舊的服務與金額)
// (1) 清除主服務與加點勾選
                    document.querySelectorAll('input[name="mainService"]').forEach(radio => {
                        radio.checked = false;
                        radio.closest('.option-card')?.classList.remove('selected', 'bg-white', 'border-brand-primary', 'shadow-md');
                    });
                    const otherCb = document.getElementById('otherServiceAddon');
                    if(otherCb) {
                        otherCb.checked = false;
                        otherCb.closest('.option-card')?.classList.remove('selected', 'bg-white', 'border-brand-primary', 'shadow-md');
                    }
                    document.getElementById('other-input-container').classList.add('hidden');
                    // (3) 清除金額與打結勾選
                    document.getElementById('basePrice').value = '';
                    const mattingCb = document.querySelector('input[name="mattingSuspected"]');
                    if(mattingCb) {
                        mattingCb.checked = false;
                        this.toggleMatting(mattingCb.parentElement);
                    }
                    // (4) 重置總金額顯示
                    this.calculateTotal();

                    // 5. 填入病史描述
                    const medicalInput = document.getElementById('medical-input');
                    medicalInput.value = data.medical_detail || '';
                    if(data.medical_history === '有') {
                        this.toggleInput('medical-input', true);
                    } else {
                        this.toggleInput('medical-input', false);
                    }

                    // 6. 觸發高風險檢查
                    this.checkRisk(data.age);
                },
                updateRadioStyle(label) {
                    const radioName = label.querySelector('input').name;
                    document.querySelectorAll(`input[name="${radioName}"]`).forEach(input => {
                        const parent = input.closest('.option-card');
                        if (parent) parent.classList.remove('selected', 'bg-white', 'border-brand-primary', 'shadow-md');
                    });
                    label.classList.add('selected', 'bg-white', 'border-brand-primary', 'shadow-md');
                    label.querySelector('input').checked = true;
                },

                toggleInput(elementId, show) {
                    const el = document.getElementById(elementId);
                    if (show) {
                        el.classList.remove('hidden');
                        el.required = true;
                        setTimeout(() => el.focus(), 100);
                    } else {
                        el.classList.add('hidden');
                        el.required = false;
                        el.value = '';
                    }
                },
// ====== 錯誤紅字工具函式 (新增) ======
clearAllFieldErrors() {
    document.querySelectorAll('.field-error-message').forEach(el => el.remove());
    document.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));
    document.querySelectorAll('.field-error-box').forEach(el => el.classList.remove('field-error-box'));
},
showFieldError(input, message) {
    if (!input) return;
    let container = input.closest('.space-y-1') || input.closest('.space-y-2') || input.closest('.grid') || input.closest('.flex') || input.parentElement;
    if (container) {
        const old = container.querySelector('.field-error-message');
        if (old) old.remove();
        const msg = document.createElement('div');
        msg.className = 'field-error-message';
        msg.innerText = message;
        container.appendChild(msg);
    }
    if (input.type === 'radio' || input.type === 'checkbox') {
        document.querySelectorAll(`input[name="${input.name}"]`).forEach(el => el.classList.add('field-error'));
    } else {
        input.classList.add('field-error');
    }
},
clearFieldError(input) {
    if (!input) return;
    if (input.type === 'radio' || input.type === 'checkbox') {
        document.querySelectorAll(`input[name="${input.name}"]`).forEach(el => el.classList.remove('field-error'));
        const container = input.closest('.space-y-1') || input.closest('.space-y-2') || input.closest('.grid') || input.closest('.flex') || input.parentElement;
        if (container) {
            const msg = container.querySelector('.field-error-message');
            if (msg) msg.remove();
        }
    } else {
        input.classList.remove('field-error');
        const container = input.closest('.space-y-1') || input.closest('.space-y-2') || input.parentElement;
        if (container) {
            const msg = container.querySelector('.field-error-message');
            if (msg) msg.remove();
        }
    }
},
showBoxError(element, message) {
    if (!element) return;
    element.classList.add('field-error-box');
    const container = element.parentElement;
    if (container) {
        const old = container.querySelector('.field-error-message');
        if (old) old.remove();
        const msg = document.createElement('div');
        msg.className = 'field-error-message';
        msg.innerText = message;
        container.appendChild(msg);
    }
},
clearBoxError(element) {
    if (!element) return;
    element.classList.remove('field-error-box');
    const container = element.parentElement;
    if (container) {
        const msg = container.querySelector('.field-error-message');
        if (msg) msg.remove();
    }
},
// 處理主服務 (二選一) 的視覺反饋
                updateServiceUI() {
                    document.querySelectorAll('input[name="mainService"]').forEach(radio => {
                        const card = radio.closest('.option-card');
                        if (radio.checked) {
                            card.classList.add('selected', 'bg-white', 'border-brand-primary', 'shadow-md');
                        } else {
                            card.classList.remove('selected', 'bg-white', 'border-brand-primary', 'shadow-md');
                        }
                    });
                },

                // 處理其他項目 (加點) 的視覺反饋與輸入框切換
                toggleOtherInput(checked) {
                    const container = document.getElementById('other-input-container');
                    const input = document.getElementById('otherServiceDetail');
                    const checkbox = document.getElementById('otherServiceAddon');
                    const card = checkbox.closest('.option-card');

                    if (checked) {
                        card.classList.add('selected', 'bg-white', 'border-brand-primary', 'shadow-md');
                        container.classList.remove('hidden');
                        input.required = true;
                        setTimeout(() => input.focus(), 100);
                    } else {
                        card.classList.remove('selected', 'bg-white', 'border-brand-primary', 'shadow-md');
                        container.classList.add('hidden');
                        input.required = false;
                        input.value = '';
                    }
                },
                toggleMatting(label) {
                    const checkbox = label.querySelector('input[type="checkbox"]');
                    const details = document.getElementById('matting-details');
                    const arrow = document.getElementById('matting-arrow');

                    setTimeout(() => {
                        if (checkbox.checked) {
                            details.classList.remove('hidden');
                            arrow.style.transform = 'rotate(180deg)';
                            label.classList.add('selected', 'bg-white', 'border-brand-primary', 'shadow-md');
                        } else {
                            details.classList.add('hidden');
                            arrow.style.transform = 'rotate(0deg)';
                            label.classList.remove('selected', 'bg-white', 'border-brand-primary', 'shadow-md');
                            document.querySelectorAll('input[name="mattingChoice"]').forEach(r => r.checked = false);
                        }
                    }, 0);
                },

                calculateTotal() {
                    let base = parseInt(document.getElementById('basePrice').value) || 0;
                    let upgradeMin = 0;
                    let upgradeMax = 0;
                    let hasVariable = false;
                    
                    const checkedUpgrades = document.querySelectorAll('input[name="spaUpgrades"]:checked');
                    const upgradeRow = document.getElementById('upgrade-row');

                    if (checkedUpgrades.length > 0) {
                        upgradeRow.classList.remove('hidden');
                    } else {
                        upgradeRow.classList.add('hidden');
                    }

                    checkedUpgrades.forEach(cb => {
                        let priceStr = cb.dataset.price.replace('+', '').replace(/元/g, '').trim();
                        if (priceStr.includes('~')) {
                            let parts = priceStr.split('~');
                            upgradeMin += parseInt(parts[0]);
                            upgradeMax += parseInt(parts[1]);
                            hasVariable = true;
                        } else {
                            let val = parseInt(priceStr);
                            upgradeMin += val;
                            upgradeMax += val;
                        }
                    });

                    let upgradeText = hasVariable ? `+$${upgradeMin} ~ $${upgradeMax}` : `+$${upgradeMin}`;
                    document.getElementById('upgradeTotalDisplay').innerText = upgradeText;

                    let totalMin = base + upgradeMin;
                    let totalMax = base + upgradeMax;
                    
                    if (totalMin === 0 && totalMax === 0) {
                        document.getElementById('totalPriceDisplay').innerText = "$0";
                        return;
                    }

                    let totalText = hasVariable ? `$${totalMin} ~ $${totalMax}` : `$${totalMin}`;
                    document.getElementById('totalPriceDisplay').innerText = totalText;
                },

async handleFormSubmit(e) {
    e.preventDefault();
    const form = e.target;

    // 先清除舊的錯誤紅字
    this.clearAllFieldErrors();

if (!form.checkValidity()) {
    const invalidInputs = Array.from(form.querySelectorAll(':invalid'));

    invalidInputs.forEach(input => {
        let fieldName = "必填欄位";
        const nameMap = {
            'phone': '手機號碼',
            'ownerName': '飼主姓名',
            'ownerId': '身分證字號',
            'email': '電子信箱',
            'address': '通訊地址',
            'emergencyName': '緊急聯絡人',
            'emergencyPhone': '緊急電話',
            'petSpecies': '寵物種類',
            'petName': '寵物名字',
            'breed': '寵物品種',
            'weight': '體重',
            'ageYear': '年齡',
            'gender': '性別',
            'ligation': '結紮狀況',
            'medicalHistory': '過往病史',
            'socialAggression': '社交狀況-對人反應',
            'socialInteraction': '社交狀況-對狗反應',
            'temperament': '攻擊性評估',
            'chipStatus': '晶片狀況',
            'paymentMethod': '支付方式',
            'agreement': '契約條款勾選',
            'basePrice': '基礎報價',
            'chipId': '晶片號碼',
        };

        if (nameMap[input.name]) {
            fieldName = nameMap[input.name];
        } else {
            const container = input.closest('.space-y-1') || input.closest('.space-y-2');
            if (container) {
                const label = container.querySelector('label:not(.option-card)');
                if (label) fieldName = label.innerText.replace('*', '').trim();
            } else if (input.placeholder) {
                fieldName = input.placeholder;
            }
        }

        this.showFieldError(input, `請填寫「${fieldName}」`);
    });

    const firstInvalid = invalidInputs[0];
    if (firstInvalid) {
        toast.show(`請檢查表單，有 ${invalidInputs.length} 個欄位未填寫`, 'error', '資料不完整');
        firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstInvalid.focus();
    }
    return;
}
    const phoneInput = document.getElementById('phone');
    const phoneRegex = /^09\d{8}$/;
    if (phoneInput.value && !phoneRegex.test(phoneInput.value)) {
        toast.show('手機號碼格式錯誤，請輸入 09 開頭的 10 碼數字', 'error');
        this.showFieldError(phoneInput, '手機號碼格式錯誤，請輸入 09 開頭 10 碼');
        phoneInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        phoneInput.focus();
        return;
    }

    // ====== 修正：身分證驗證 bug ======
    const ownerIdInput = document.getElementById('ownerId');
    const idRegex = /^[A-Z][12]\d{8}$/;
    if (ownerIdInput.value && !idRegex.test(ownerIdInput.value)) {
        toast.show('身分證字號格式錯誤，請輸入 1 碼大寫字母 + 9 碼數字', 'error');
        this.showFieldError(ownerIdInput, '身分證格式錯誤');
        ownerIdInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        ownerIdInput.focus();
        return;
    }

    // --- 緊急聯絡電話格式驗證 ---
    const emergencyPhoneInput = document.getElementById('emergencyPhone');
    if (emergencyPhoneInput.value && !phoneRegex.test(emergencyPhoneInput.value)) {
        toast.show('緊急聯絡電話格式錯誤，請輸入 09 開頭的 10 碼數字', 'error');
        this.showFieldError(emergencyPhoneInput, '緊急電話格式錯誤');
        emergencyPhoneInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        emergencyPhoneInput.focus();
        return;
    }

    const chipStatus = document.querySelector('input[name="chipStatus"]:checked');
    const chipInput = document.getElementById('chip-input');
    if (chipStatus && chipStatus.value === '有晶片' && chipInput.value) {
        const chipRegex = /^\d{10}$|^\d{15}$/;
        if (!chipRegex.test(chipInput.value)) {
            toast.show('晶片號碼格式錯誤，請輸入 10 或 15 碼數字', 'error');
            this.showFieldError(chipInput, '晶片號碼格式錯誤');
            chipInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            chipInput.focus();
            return;
        }
    }

    const basePriceInput = document.getElementById('basePrice');
    if (!basePriceInput.value || parseInt(basePriceInput.value) <= 0) {
        toast.show('請填寫基礎報價金額', 'error');
        this.showFieldError(basePriceInput, '請填寫基礎報價');
        basePriceInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        basePriceInput.focus();
        return;
    }

    if (!this.state.lineConfirmed) {
        toast.show('請先加入 LINE 並傳送貼圖，我們才能聯繫您喔！', 'warning', '步驟未完成');
        document.getElementById('view-grooming').scrollIntoView({ behavior: 'smooth' });
        return;
    }
    
    const mattingCheckbox = document.querySelector('input[name="mattingSuspected"]');
    if (mattingCheckbox && mattingCheckbox.checked) {
        const mattingChoice = document.querySelector('input[name="mattingChoice"]:checked');
        if (!mattingChoice) {
            toast.show('您勾選了「疑似有打結」，請往下滑選擇一種處理方案。', 'warning');
            const anyMattingInput = document.querySelector('input[name="mattingChoice"]');
            this.showFieldError(anyMattingInput, '請選擇打結處理方案');
            document.getElementById('matting-details').scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }
    }

    const riskBanner = document.getElementById('risk-warning-banner');
    if (!riskBanner.classList.contains('hidden')) {
        const riskInput = document.getElementById('risk-checkbox');
        if (!riskInput.checked) {
            toast.show('請勾選「同意承擔高風險服務責任」才能繼續', 'error');
            this.showFieldError(riskInput, '請勾選同意高風險責任');
            const container = document.getElementById('risk-checkbox-container');
            container.scrollIntoView({ behavior: 'smooth', block: 'center' });
            container.classList.add('animate-pulse');
            setTimeout(() => container.classList.remove('animate-pulse'), 500);
            return;
        }
    }

    if(document.getElementById('signatureData').value === '') {
        toast.show('請點擊簽名板進行簽署', 'error');
        const sigTrigger = document.getElementById('signature-trigger');
        this.showBoxError(sigTrigger, '請點擊簽名板進行簽署');
        sigTrigger.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    }

    toast.show('正在上傳預約資料，請稍候...', 'warning', '處理中');
    const submitBtn = document.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerText = '上傳中...';

    const signatureBase64 = document.getElementById('signatureData').value;
    let signatureUrl = '';

    try {
        const fetchResponse = await fetch(signatureBase64);
        const blob = await fetchResponse.blob();
        const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.png`;

        const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
            .from('signatures')
            .upload(fileName, blob, {
                cacheControl: '3600',
                upsert: false
            });

        if (uploadError) {
            throw uploadError;
        }

        const { data: urlData } = window.supabaseClient.storage
            .from('signatures')
            .getPublicUrl(fileName);
        
        signatureUrl = urlData.publicUrl;

    } catch (error) {
        console.error('簽名上傳失敗:', error);
        toast.show('簽名上傳失敗，請稍後再試', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> 確認送出預約';
        lucide.createIcons();
        return;
    }

    const formData = {
        line_confirmed: this.state.lineConfirmed,
        // --- 飼主基本資料 ---
        owner_name: document.getElementById('ownerName').value,
        owner_phone: document.getElementById('phone').value,
        owner_id: document.getElementById('ownerId').value,
        email: document.getElementById('email').value,
        address: document.getElementById('address').value,
        
        // --- 緊急聯絡人 ---
        emergency_name: document.getElementById('emergencyName').value,
        emergency_phone: document.getElementById('emergencyPhone').value,
        
        // --- 預約偏好 ---
        preferred_clinic: document.getElementById('preferredClinic').value,
        
        // --- 寵物基本資料 ---
        pet_name: document.getElementById('petName').value,
        pet_species: document.querySelector('input[name="petSpecies"]:checked').value,
        breed: document.getElementById('breed').value,
        weight: parseFloat(document.getElementById('weight').value),
        age: parseInt(document.getElementById('ageYear').value),
        gender: document.querySelector('input[name="gender"]:checked').value,
        ligation: document.querySelector('input[name="ligation"]:checked').value,
        
        // --- 健康與行為 ---
        medical_history: document.querySelector('input[name="medicalHistory"]:checked').value,
        medical_detail: document.getElementById('medical-input').value,
        
        social_aggression: document.querySelector('input[name="socialAggression"]:checked').value,
        social_interaction: document.querySelector('input[name="socialInteraction"]:checked').value,
        temperament: document.querySelector('input[name="temperament"]:checked').value,
        
        // --- 晶片資訊 ---
        chip_status: document.querySelector('input[name="chipStatus"]:checked').value,
        chip_id: document.getElementById('chip-input').value,
        
        // --- 服務與金額 (主服務 + 加點項目) ---
        service_type: (() => {
            const mainEl = document.querySelector('input[name="mainService"]:checked');
            let result = mainEl ? mainEl.value : '';
            const isOtherChecked = document.getElementById('otherServiceAddon').checked;
            if (isOtherChecked) {
                const detail = document.getElementById('otherServiceDetail').value;
                const prefix = result ? ' + ' : ''; 
                result += `${prefix}其他項目${detail ? `(${detail})` : ''}`;
            }
            return result || '未選擇';
        })(),

        base_price: parseInt(document.getElementById('basePrice').value),
        
        upgrade_price: (() => {
            let prices = [];
            document.querySelectorAll('input[name="spaUpgrades"]:checked').forEach(cb => {
                let priceStr = cb.dataset.price; 
                prices.push(priceStr.replace('+', ''));
            });
            return prices.join(', ');
        })(), 
        
        total_price: (() => {
            const base = parseInt(document.getElementById('basePrice').value) || 0;
            let ranges = [];
            document.querySelectorAll('input[name="spaUpgrades"]:checked').forEach(cb => {
                let priceStr = cb.dataset.price.replace('+', '').trim();
                if (priceStr.includes('~')) {
                    ranges.push(priceStr);
                } else {
                    let val = parseInt(priceStr);
                    if (!isNaN(val)) ranges.push(val);
                }
            });
            let minTotal = base;
            let maxTotal = base;
            ranges.forEach(r => {
                if (typeof r === 'string') {
                    let parts = r.split('~').map(p => parseInt(p));
                    if (!isNaN(parts[0])) minTotal += parts[0];
                    if (!isNaN(parts[1])) maxTotal += parts[1];
                } else {
                    minTotal += r;
                    maxTotal += r;
                }
            });
            return minTotal === maxTotal ? minTotal : `${minTotal}~${maxTotal}`;
        })(),
        
        payment_method: document.querySelector('input[name="paymentMethod"]:checked').value,
        spa_upgrades: Array.from(document.querySelectorAll('input[name="spaUpgrades"]:checked')).map(cb => cb.value).join(', '),
        
        matting_suspected: mattingCheckbox ? mattingCheckbox.checked : false,
        matting_choice: mattingCheckbox && mattingCheckbox.checked ? (document.querySelector('input[name="mattingChoice"]:checked')?.value || '') : '',
        
        signature_data: signatureUrl,
        status: 'pending'
    };

    const spaCheckboxes = document.querySelectorAll('input[name="spaUpgrades"]:checked');
    const spaList = Array.from(spaCheckboxes).map(cb => cb.value);
    formData.spa_upgrades = spaList.join(', ');

    formData.matting_suspected = mattingCheckbox ? mattingCheckbox.checked : false;
    if (formData.matting_suspected) {
        const mattingChoice = document.querySelector('input[name="mattingChoice"]:checked');
        formData.matting_choice = mattingChoice ? mattingChoice.value : '';
    }

    const { data, error } = await window.supabaseClient
        .from('bookings')
        .insert([formData])
        .select();

    if (error) {
        console.error('Supabase Error:', error);
        toast.show('上傳失敗，請稍後再試或聯繫店家', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> 確認送出預約';
    } else {
        const emailInput = document.getElementById('email').value.trim();
        const hasEmail = emailInput !== '';

        if (hasEmail) {
            window.supabaseClient.functions.invoke('send-mail', {
                body: { 
                    email: formData.email,
                    owner_name: formData.owner_name,
                    pet_name: formData.pet_name,
                    htmlContent: this.generateEmailHTML(formData) 
                }
            }).then(({ error }) => {
                if (error) console.error('Email 發送失敗:', error);
            });
        }

        toast.show('預約成功！準備跳轉...', 'success');

        setTimeout(() => {
            form.reset();
            this.state.lineConfirmed = false;
            document.getElementById('sig-image').src = '';
            document.getElementById('signature-result').classList.add('hidden');
            document.getElementById('signature-trigger').classList.remove('hidden');
            this.toggleLineCheck();
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> 確認送出預約';

            this.showDownloadPage(formData, hasEmail);
            
        }, 1000);
    }
},
                // --- 修改：產生合約 HTML (供截圖與 Email 使用) ---
                generateEmailHTML(data) {
                    const now = new Date().toLocaleString('zh-TW', { hour12: false });
                    
                    // 判定高風險邏輯
                    const isHighRisk = (data.age >= 8 || data.age <= 1) || 
                                     data.medical_history === '有' || 
                                     data.temperament === '恰北北/護主';

                    // 樣式設定
                    const style = {
                        container: "font-family: 'Microsoft JhengHei', sans-serif; max-width: 800px; margin: 0 auto; background-color: #ffffff; color: #333; line-height: 1.5;",
                        header: "text-align: center; border-bottom: 3px solid #C7B299; padding-bottom: 20px; margin-bottom: 25px;",
                        sectionBox: "border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 15px;",
                        sectionTitle: "background-color: #F9F4F0; color: #594A42; font-weight: bold; padding: 8px 12px; margin: -12px -12px 12px -12px; border-radius: 8px 8px 0 0; border-bottom: 1px solid #ddd; font-size: 14px;",
                        table: "width: 100%; border-collapse: collapse; font-size: 13px;",
                        tdLabel: "width: 22%; padding: 6px; color: #666; font-weight: bold; border-bottom: 1px solid #eee; vertical-align: top;",
                        tdValue: "padding: 6px; color: #000; border-bottom: 1px solid #eee;",
                        warningBox: "background-color: #fff5f5; border: 2px solid #fc8181; color: #c53030; padding: 15px; border-radius: 8px; margin-bottom: 20px;",
                        termText: "font-size: 11px; color: #555; text-align: justify; margin-bottom: 6px; line-height: 1.4;",
                        termHeader: "font-size: 12px; font-weight: bold; color: #594A42; margin-top: 10px; margin-bottom: 5px;"
                    };

                    // 1. 一般條款全文 (對應 modal-general-content)
                    const generalTerms = `
                        <div style="${style.termText}"><span style="color:#000;font-weight:bold;">第一條(契約目的與服務範圍)</span> 本契約所稱犬、貓美容服務，係指清洗、清潔、吹乾、梳毛、毛髮修剪及造型設計等行為，不涉及任何動物醫療行為。</div>
                        <div style="${style.termText}"><span style="color:#000;font-weight:bold;">第二條(資訊揭露與契約效力)</span> 本契約及其附件、公告事項，均視為本契約之一部分，經雙方簽署後生效。</div>
                        <div style="${style.termText}"><span style="color:#000;font-weight:bold;">第三條(基本資料)</span> 應記載犬、貓、飼主及美容店之基本資料，詳如填載內容。</div>
                        <div style="${style.termText}"><span style="color:#000;font-weight:bold;">第四條(詢問義務與誠實告知)</span> 飼主應誠實告知寵物個性、攻擊性、病史。若未如實告知致發生異常，非店家之責。</div>
                        <div style="${style.termText}"><span style="color:#000;font-weight:bold;">第五條(攻擊行為與安全中止)</span> 若出現抓咬、持續抗拒等危及安全行為，店家得立即中止服務。</div>
                        <div style="${style.termText}"><span style="color:#000;font-weight:bold;">第六條(抗拒、躁動致無法完成服務)</span> 因寵物緊張躁動致難以繼續，店家得中止或縮短流程，屬不可歸責雙方之事由。</div>
                        <div style="${style.termText}"><span style="color:#000;font-weight:bold;">第七條(應激反應與突發異常)</span> 美容期間如發生應激反應(喘氣/失禁等)，店家將即時處理或送醫。非人為疏失不負賠償責任。</div>
                        <div style="${style.termText}"><span style="color:#000;font-weight:bold;">第八條(毛髮打結與處理方式調整)</span> 現場發現嚴重打結，店家得依實際狀況調整處理方式（包含剃毛）及計收拆結費。</div>
                        <div style="${style.termText}"><span style="color:#000;font-weight:bold;">第九條(服務中止與費用計算)</span> 即使服務未完成，已實施之洗、吹、剪等項目，飼主仍需支付費用。</div>
                        <div style="${style.termText}"><span style="color:#000;font-weight:bold;">第十條(異常狀況及責任歸屬)</span> 發生異常或死亡，若屬店家過失依法負責；非店家過失則不負賠償責任。</div>
                        
                        <div style="${style.termHeader}">二、服務項目與收費</div>
                        <div style="${style.termText}">收費以現場評估體重/毛量為準。發現寄生蟲需加收環境清潔費$1000。美容後逾時1小時未接回，將收取安親費(犬$200/貓$300每小時)。</div>

                        <div style="${style.termHeader}">三、健康與接待規定</div>
                        <div style="${style.termText}">不接待：未滿3個月、疫苗未全、有傳染病、心臟病、癲癇之寵物。故意隱瞞致人員受傷需負擔醫療費。</div>

                        <div style="${style.termHeader}">四、其他條款</div>
                        <div style="${style.termText}">1. 輕微剃傷(小於1cm)為美容常見風險，店家負責消毒。操作疏失最高賠償$2000。<br>2. 緊急狀況無法聯繫飼主時，將立即送醫，費用由飼主負擔。<br>3. 飼主同意店家拍攝並使用照片於行銷用途。</div>
                    `;

                    // 2. 高風險條款全文 (對應 modal-risk-content)
                    const riskTerms = `
                        <div style="font-weight:bold; margin-bottom:10px; border-bottom:1px solid #feb2b2; padding-bottom:5px;">⚠️ 高風險寵物美容特別條款</div>
                        <div style="${style.termText}"><strong>一、飼主誠實告知義務</strong> 本人確認已完整告知寵物年齡、病史及行為特性。如因未告知致生意外，店家不負責任。</div>
                        <div style="${style.termText}"><strong>二、高齡與特殊健康狀況之風險</strong> 本人知悉高齡(8歲+)或幼體(1歲-)寵物，美容過程可能因緊張誘發休克、舊疾復發。若非店家故意或重大過失，店家不負賠償責任。</div>
                        <div style="${style.termText}"><strong>三、攻擊性與安全防護</strong> 若寵物有攻擊性，同意店家採取戴嘴套等防護措施。若危及安全，店家得隨時中止服務並收費。</div>
                        <div style="${style.termText}"><strong>四、緊急醫療處置</strong> 發生緊急狀況時，同意店家優先將寵物送醫，費用由本人負擔。</div>
                    `;

                    return `
                        <html>
                        <head><title>美容服務契約書 - ${data.pet_name}</title></head>
                        <body style="background-color: #f0f0f0; padding: 20px;">
                        <div style="${style.container}">
                            <div style="padding: 30px;">
                                <div style="${style.header}">
                                    <h1 style="color: #594A42; margin: 0; font-size: 24px; letter-spacing: 2px;">麥克諾尼 | 日式寵物沙龍</h1>
                                    <p style="color: #8A7B70; font-size: 14px; margin: 8px 0 0 0;">寵物美容服務定型化契約書</p>
                                    <div style="font-size: 11px; color: #999; margin-top: 8px; font-family: monospace;">
                                        單號：${Date.now()} / 簽署時間：${now}
                                    </div>
                                </div>

                                <div style="${style.sectionBox}">
                                    <div style="${style.sectionTitle}">▍ 飼主基本資料</div>
                                    <table style="${style.table}">
                                        <tr><td style="${style.tdLabel}">飼主姓名</td><td style="${style.tdValue}">${data.owner_name}</td></tr>
                                        <tr><td style="${style.tdLabel}">聯絡電話</td><td style="${style.tdValue}">${data.owner_phone}</td></tr>
                                        <tr><td style="${style.tdLabel}">身分證字號</td><td style="${style.tdValue}">${data.owner_id}</td></tr>
                                        <tr><td style="${style.tdLabel}">電子信箱</td><td style="${style.tdValue}">${data.email || '<span style="color:#ccc">未填寫</span>'}</td></tr>
                                        <tr><td style="${style.tdLabel}">通訊地址</td><td style="${style.tdValue}">${data.address}</td></tr>
                                        <tr><td style="${style.tdLabel}">緊急聯絡人</td><td style="${style.tdValue}">${data.emergency_name} (${data.emergency_phone})</td></tr>
                                        <tr><td style="${style.tdLabel}">指定醫院</td><td style="${style.tdValue}">${data.preferred_clinic || '無 (由店家指定)'}</td></tr>
                                    </table>
                                </div>

                                <div style="${style.sectionBox}">
                                    <div style="${style.sectionTitle}">▍ 寵物詳細資料</div>
                                    <table style="${style.table}">
                                        <tr>
                                            <td style="${style.tdLabel}">名字/品種</td>
                                            <td style="${style.tdValue}">${data.pet_name} (${data.breed})</td>
                                        </tr>
                                        <tr>
                                            <td style="${style.tdLabel}">基本資訊</td>
                                            <td style="${style.tdValue}">
                                                ${data.pet_species} / ${data.gender} / ${data.weight} kg / ${data.age} 歲
                                                ${(data.age >= 8 || data.age <= 1) ? '<span style="color:red; font-weight:bold;">(高風險年齡)</span>' : ''}
                                            </td>
                                        </tr>
                                        <tr><td style="${style.tdLabel}">結紮狀況</td><td style="${style.tdValue}">${data.ligation}</td></tr>
                                        <tr>
                                            <td style="${style.tdLabel}">晶片號碼</td>
                                            <td style="${style.tdValue}">
                                                ${data.chip_status} 
                                                ${data.chip_id ? `<span style="font-family:monospace; font-weight:bold; margin-left:5px;">(${data.chip_id})</span>` : ''}
                                            </td>
                                        </tr>
                                    </table>
                                </div>

                                <div style="${style.sectionBox}">
                                    <div style="${style.sectionTitle}">▍ 健康與行為評估</div>
                                    <table style="${style.table}">
                                        <tr>
                                            <td style="${style.tdLabel}">過往病史</td>
                                            <td style="${style.tdValue}">
                                                ${data.medical_history}
                                                ${data.medical_detail ? `<br><span style="color:#666; font-size:12px;">說明：${data.medical_detail}</span>` : ''}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="${style.tdLabel}">社交/互動</td>
                                            <td style="${style.tdValue}">
                                                對狗：${data.social_interaction}<br>
                                                對人：${data.social_aggression}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="${style.tdLabel}">美容性情</td>
                                            <td style="${style.tdValue}">
                                                ${data.temperament}
                                                ${data.temperament === '恰北北/護主' ? '<span style="color:red; font-weight:bold;"> (需加強防護)</span>' : ''}
                                            </td>
                                        </tr>
                                    </table>
                                </div>

                                <div style="${style.sectionBox} border-color: #C7B299;">
                                    <div style="${style.sectionTitle} background-color: #C7B299; color: white;">▍ 本次服務項目確認</div>
                                    <table style="${style.table}">
                                        <tr><td style="${style.tdLabel}">服務項目</td><td style="${style.tdValue} font-weight:bold;">${data.service_type}</td></tr>
                                        <tr><td style="${style.tdLabel}">升級 SPA</td><td style="${style.tdValue}">${data.spa_upgrades || '無'}</td></tr>
                                        <tr>
                                            <td style="${style.tdLabel}">打結/拆結</td>
                                            <td style="${style.tdValue}">
                                                ${data.matting_suspected ? 
                                                    `<span style="color:#d97706; font-weight:bold;">疑似有打結 (方案：${data.matting_choice})</span>` : 
                                                    '無'}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="${style.tdLabel}">支付方式</td>
                                            <td style="${style.tdValue}">${data.payment_method}</td>
                                        </tr>
                                        <tr style="background-color: #fcfcfc;">
                                            <td style="${style.tdLabel} border-bottom:none; padding-top:15px;">金額預估</td>
                                            <td style="${style.tdValue} border-bottom:none; font-size: 20px; font-weight: bold; color: #594A42; padding-top:15px;">
                                                $${data.total_price}
                                                <div style="font-size:10px; color:#999; font-weight:normal;">(含基礎報價 $${data.base_price} + 升級 $${data.upgrade_price || 0})</div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>

                                ${isHighRisk ? `<div style="${style.warningBox}">${riskTerms}</div>` : ''}

<div style="margin-top: 25px;">
                                    <h3 style="font-size: 14px; border-bottom: 2px solid #eee; padding-bottom: 5px; color:#888;">美容服務契約條款全文</h3>
                                    ${generalTerms}
                                </div>
                                <div style="${style.sectionBox} margin-top: 20px; border-style: dashed; border-color: #cbd5e1; background-color: #f8fafc;">
                                    <div style="${style.sectionTitle} background-color: #eee; color: #333;">▍ 業者基本資料 (乙方)</div>
                                    <table style="${style.table}">
                                        <tr><td style="${style.tdLabel}">店家名稱</td><td style="${style.tdValue}">麥克諾尼寵物沙龍</td></tr>
                                        <tr><td style="${style.tdLabel}">聯絡電話</td><td style="${style.tdValue}">02-27129404</td></tr>
                                        <tr><td style="${style.tdLabel}">店家地址</td><td style="${style.tdValue}">台北市松山區敦化北路222巷20號</td></tr>
                                        <tr><td style="${style.tdLabel}">營業時間</td><td style="${style.tdValue}">9:00-18:00 (每週三、週日公休)</td></tr>
                                        <tr>
                                            <td style="${style.tdLabel}">特約醫院</td>
                                            <td style="${style.tdValue}">
                                                上群動物醫院<br>
                                                <span style="font-size:11px; color:#666;">(02)2775-3007 / 台北市中山區南京東路三段215號</span>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px dashed #ccc; text-align: center;">
                                    <p style="font-weight: bold; margin-bottom: 10px;">立契約書人 (飼主) 簽署</p>
                                    <div style="display:inline-block; border:1px solid #eee; padding:10px; border-radius:10px;">
                                        <img src="${data.signature_data}" style="max-height: 100px; max-width: 100%; display: block;" alt="飼主簽名" />
                                    </div>
                                    <p style="font-size: 11px; color: #999; margin-top: 5px;">
                                        (由系統自動紀錄) / Time: ${now}
                                    </p>
                                    <p style="font-size: 11px; color: #999; margin-top: 20px;">
                                        本契約副本已由系統自動留存，並具備法律效力。
                                    </p>
                                </div>
                            </div>
                        </div>
                        </body>
                        </html>
                    `;
                },
                
                // --- 新增：顯示下載頁面與警告邏輯 ---
                showDownloadPage(contractData, hasEmail) {
                    // 1. 隱藏所有原本的 View
                    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                    document.getElementById('back-btn').classList.add('hidden'); // 隱藏返回按鈕

                    // 2. 移除舊的下載頁 (如果有的話)
                    const oldView = document.getElementById('view-download');
                    if(oldView) oldView.remove();

                    // 3. 準備標題與警告內容
                    const title = hasEmail ? '契約已寄出！' : '提交成功！';
                    
                    // 根據有無 Email 顯示不同顏色的警告框
                    const alertBox = hasEmail
                        ? `<div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6 text-sm text-blue-800 shadow-sm">
                             <div class="font-bold flex items-center gap-2 mb-2 text-lg"><i data-lucide="mail-check" class="w-5 h-5"></i> 副本已寄出</div>
                             <p class="leading-relaxed">契約副本已發送至您的信箱。<br>建議您仍可點擊下方按鈕，開啟完整契約進行<strong>截圖備份</strong>。</p>
                           </div>`
                        : `<div class="bg-red-50 border-2 border-red-200 rounded-xl p-4 mb-6 text-sm text-red-800 animate-pulse shadow-md">
                             <div class="font-bold flex items-center gap-2 mb-2 text-lg"><i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i> 未填寫信箱</div>
                             <p class="leading-relaxed font-bold text-base">您未填寫 Email，無法收到電子副本。</p>
                             <p class="mt-2 text-red-600">請務必點擊下方按鈕開啟契約，並立即<span class="text-xl underline">截圖保存</span>！</p>
                           </div>`;

                    // 4. 建立新的 View
                    const main = document.querySelector('main');
                    const downloadView = document.createElement('div');
                    downloadView.id = 'view-download';
                    downloadView.className = 'view-section active animate-fade-in space-y-6 px-2';
                    
                    downloadView.innerHTML = `
                        <div class="text-center pt-10 pb-4">
                            <div class="w-24 h-24 mx-auto mb-4 rounded-full ${hasEmail ? 'bg-[#06C755]/10' : 'bg-red-100'} flex items-center justify-center">
                                <i data-lucide="${hasEmail ? 'check' : 'alert-circle'}" class="w-12 h-12 ${hasEmail ? 'text-[#06C755]' : 'text-red-500'} stroke-[3]"></i>
                            </div>
                            <h2 class="text-3xl font-bold text-brand-text mb-2 tracking-wide">${title}</h2>
                        </div>
                        
                        <div>${alertBox}</div>
                        
                        <div class="space-y-4 pt-4">
                            <button onclick="app.openFullContract()" class="w-full bg-brand-text text-white py-5 rounded-2xl font-bold shadow-xl shadow-brand-text/30 flex items-center justify-center gap-3 text-lg hover:bg-brand-dark active:scale-95 transition-all group border-2 border-brand-text">
                                <div class="bg-white/20 p-2 rounded-full group-hover:rotate-12 transition-transform">
                                    <i data-lucide="camera" class="w-6 h-6 text-white"></i>
                                </div>
                                <span>開啟完整契約 (截圖保存)</span>
                            </button>

                            <button onclick="window.location.reload()" class="w-full bg-white text-brand-light py-4 rounded-2xl font-bold shadow-sm border border-gray-200 flex items-center justify-center gap-2 active:scale-95 transition-all hover:bg-gray-50">
                                <i data-lucide="home" class="w-5 h-5"></i>
                                <span>返回首頁 (完成)</span>
                            </button>
                        </div>
                        <div class="h-20"></div>
                    `;
                    
                    main.appendChild(downloadView);
                    lucide.createIcons();
                    window.scrollTo({top: 0, behavior: 'smooth'});

                    // 暫存資料給 openFullContract 使用
this.lastContractData = contractData;
                },

                // --- 新增：開啟新視窗顯示合約 ---
                openFullContract() {
                    if (!this.lastContractData) return;
                    const content = this.generateEmailHTML(this.lastContractData);
                    const newWin = window.open('', '_blank');
                    if (newWin) {
                        newWin.document.write(content);
                        newWin.document.close();
                    } else {
                        alert('彈出視窗被阻擋，請允許開啟視窗');
                    }
                },
                signaturePad: {
                    canvas: null,
                    ctx: null,
                    isDrawing: false,
                    lastX: 0,
                    lastY: 0,
                    
                    init() {
                        const modal = document.getElementById('signature-modal');
                        const container = document.getElementById('canvas-container');
                        
const resizeCanvas = () => {
    if (modal.classList.contains('hidden')) return;
    this.canvas = document.getElementById('sig-canvas');
    this.ctx = this.canvas.getContext('2d');
    
    // --- [新增] High DPI 支援，讓簽名在手機上變清晰 ---
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    this.canvas.width = container.clientWidth * ratio;
    this.canvas.height = container.clientHeight * ratio;
    this.ctx.scale(ratio, ratio);
    // ------------------------------------------------
    
    // 樣式設定 (不用變)
    this.ctx.lineWidth = 3;
    this.ctx.lineCap = 'round';
    this.ctx.lineJoin = 'round';
    this.ctx.strokeStyle = '#594A42';
};
                        
                        window.addEventListener('resize', resizeCanvas);
                        this.bindEvents();
                    },
                    
                    bindEvents() {
                        document.getElementById('sig-canvas').addEventListener('mousedown', (e) => {
                            this.isDrawing = true;
                            const rect = this.canvas.getBoundingClientRect();
                            this.lastX = e.clientX - rect.left;
                            this.lastY = e.clientY - rect.top;
                        });
                        
                        document.getElementById('sig-canvas').addEventListener('mousemove', (e) => {
                            if (!this.isDrawing) return;
                            const rect = this.canvas.getBoundingClientRect();
                            const x = e.clientX - rect.left;
                            const y = e.clientY - rect.top;
                            this.draw(x, y);
                        });
                        
                        document.getElementById('sig-canvas').addEventListener('mouseup', () => this.isDrawing = false);
                        document.getElementById('sig-canvas').addEventListener('mouseout', () => this.isDrawing = false);
                        
                        document.getElementById('sig-canvas').addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            this.isDrawing = true;
                            const rect = this.canvas.getBoundingClientRect();
                            const touch = e.touches[0];
                            this.lastX = touch.clientX - rect.left;
                            this.lastY = touch.clientY - rect.top;
                        }, { passive: false });
                        
                        document.getElementById('sig-canvas').addEventListener('touchmove', (e) => {
                            e.preventDefault();
                            if (!this.isDrawing) return;
                            const rect = this.canvas.getBoundingClientRect();
                            const touch = e.touches[0];
                            const x = touch.clientX - rect.left;
                            const y = touch.clientY - rect.top;
                            this.draw(x, y);
                        }, { passive: false });
                        
                        document.getElementById('sig-canvas').addEventListener('touchend', () => this.isDrawing = false);
                    },
                    
                    draw(x, y) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(this.lastX, this.lastY);
                        this.ctx.lineTo(x, y);
                        this.ctx.stroke();
                        this.lastX = x;
                        this.lastY = y;
                    },
                    
                    open() {
                        const modal = document.getElementById('signature-modal');
                        modal.classList.remove('hidden');
                        modal.classList.add('flex');
                        document.body.style.overflow = 'hidden';
                        
                        setTimeout(() => {
                            const container = document.getElementById('canvas-container');
                            this.canvas = document.getElementById('sig-canvas');
                            this.ctx = this.canvas.getContext('2d');
                            
                            this.canvas.width = container.clientWidth;
                            this.canvas.height = container.clientHeight;
                            
                            this.ctx.lineWidth = 3;
                            this.ctx.lineCap = 'round';
                            this.ctx.lineJoin = 'round';
                            this.ctx.strokeStyle = '#594A42';
                        }, 100);
                    },
                    
                    close() {
                        const modal = document.getElementById('signature-modal');
                        modal.classList.add('hidden');
                        modal.classList.remove('flex');
                        document.body.style.overflow = '';
                    },
                    
                   
                    save() {
                        const dataUrl = this.canvas.toDataURL('image/png');
                        
                        document.getElementById('signature-trigger').classList.add('hidden');
                        document.getElementById('signature-result').classList.remove('hidden');
                        document.getElementById('sig-image').src = dataUrl;
                        document.getElementById('signatureData').value = dataUrl;
                        app.clearBoxError(document.getElementById('signature-trigger'));
                        
                        const now = new Date();
                        const timeStr = now.getFullYear() + '/' + 
                                       (now.getMonth()+1).toString().padStart(2, '0') + '/' + 
                                       now.getDate().toString().padStart(2, '0') + ' ' + 
                                       now.getHours().toString().padStart(2, '0') + ':' + 
                                       now.getMinutes().toString().padStart(2, '0') + ':' + 
                                       now.getSeconds().toString().padStart(2, '0');
                        document.getElementById('sig-timestamp').innerText = timeStr;

                        this.close();
                        
                        lucide.createIcons();
                    },
                    
// 在 signaturePad 物件內，替換掉原本的 clear()
clear() {
    if (this.ctx && this.canvas) {
        // [修正] 在手機上最穩定的清空方式是「重新設定寬度」
        // 這會強制瀏覽器重繪整個 Canvas，解決殘影問題
        this.canvas.width = this.canvas.width;
        
        // [重要] 重設寬度後，畫筆樣式會被重置，必須重新設定回來！
        this.ctx.lineWidth = 3;
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
        this.ctx.strokeStyle = '#594A42';
    }
},                    
                    reset() {
                        if(confirm('確定要清除目前的簽名並重新簽署嗎？')) {
                            toast.show('已清除，請重新簽名', 'warning');
                            document.getElementById('signature-trigger').classList.remove('hidden');
                            document.getElementById('signature-result').classList.add('hidden');
                            document.getElementById('signatureData').value = '';
                            document.getElementById('sig-image').src = '';
                        }
                    }
                }
            });

            // --- 3. 啟動應用程式 ---
            app.init();
        });
    </script>
    <div id="terms-modal" class="fixed inset-0 z-[60] bg-white hidden flex-col animate-fade-in">
        <div class="bg-white/90 backdrop-blur-md px-5 py-4 flex justify-between items-center shadow-sm shrink-0 border-b border-brand-primary/10 relative z-10">
            <h3 id="modal-title" class="font-bold text-lg text-brand-text">服務契約條款</h3>
            <button type="button" onclick="app.toggleTermsModal(false)" class="p-2 bg-gray-100 rounded-full text-brand-light hover:bg-gray-200 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 bg-[#F9F4F0] space-y-6">
            
            <div id="modal-general-content" class="bg-white p-5 rounded-2xl shadow-sm border border-brand-primary/10 space-y-4">
                <h4 class="text-sm font-black text-brand-primary border-b border-brand-primary/10 pb-2">一般美容服務條款</h4>
                <div class="text-xs text-brand-text leading-relaxed space-y-4 text-justify">
                    <p class="font-bold text-brand-dark">為保障寵物安全及服務品質，飼主預約前請詳閱。預約即視為同意：</p>
                    
                    <div><span class="font-bold text-brand-dark">第一條(契約目的與服務範圍)</span><br>本契約所稱犬、貓美容服務，係指清洗、清潔、吹乾、梳毛、毛髮修剪及造型設計等行為，不涉及任何動物醫療行為。</div>
                    <div><span class="font-bold text-brand-dark">第二條(資訊揭露與契約效力)</span><br>本契約及其附件、公告事項，均視為本契約之一部分，經雙方簽署後生效。</div>
                    <div><span class="font-bold text-brand-dark">第三條（基本資料）</span><br>應記載犬、貓、飼主及美容店之基本資料，詳如填載內容。</div>
                    <div><span class="font-bold text-brand-dark">第四條（詢問義務與誠實告知）</span><br>飼主應誠實告知寵物個性、攻擊性、病史。若未如實告知致發生異常，非店家之責。</div>
                    <div><span class="font-bold text-brand-dark">第五條（攻擊行為與安全中止）</span><br>若出現抓咬、持續抗拒等危及安全行為，店家得立即中止服務。</div>
                    <div><span class="font-bold text-brand-dark">第六條（抗拒、躁動致無法完成服務）</span><br>因寵物緊張躁動致難以繼續，店家得中止或縮短流程，屬不可歸責雙方之事由。</div>
                    <div><span class="font-bold text-brand-dark">第七條（應激反應與突發異常）</span><br>美容期間如發生應激反應(喘氣/失禁等)，店家將即時處理或送醫。非人為疏失不負賠償責任。</div>
                    <div><span class="font-bold text-brand-dark">第八條（毛髮打結與處理方式調整）</span><br>現場發現嚴重打結，店家得依實際狀況調整處理方式（包含剃毛）及計收拆結費。</div>
                    <div><span class="font-bold text-brand-dark">第九條（服務中止與費用計算）</span><br>即使服務未完成，已實施之洗、吹、剪等項目，飼主仍需支付費用。</div>
                    <div><span class="font-bold text-brand-dark">第十條（異常狀況及責任歸屬）</span><br>發生異常或死亡，若屬店家過失依法負責；非店家過失則不負賠償責任。</div>
                    <div><span class="font-bold text-brand-dark">二、服務項目與收費</span><br>收費以現場評估體重/毛量為準。發現寄生蟲需加收環境清潔費$1000。美容後逾時1小時未接回，將收取安親費(犬$200/貓$300每小時)。</div>
                    <div><span class="font-bold text-brand-dark">三、健康與接待規定</span><br>不接待：未滿3個月、疫苗未全、有傳染病、心臟病、癲癇之寵物。故意隱瞞致人員受傷需負擔醫療費。</div>
                    <div><span class="font-bold text-brand-dark">四、其他條款</span><br>1. 輕微剃傷(小於1cm)為美容常見風險，店家負責消毒。操作疏失最高賠償$2000。<br>2. 緊急狀況無法聯繫飼主時，將立即送醫，費用由飼主負擔。<br>3. 飼主同意店家拍攝並使用照片於行銷用途。</div>
                </div>
            </div>

            <div id="modal-risk-content" class="bg-red-50 p-5 rounded-2xl shadow-sm border border-red-200 space-y-4">
                <div class="flex items-center gap-2 border-b border-red-200 pb-2">
                     <i data-lucide="alert-triangle" class="w-5 h-5 text-red-500"></i>
                     <h4 class="text-sm font-black text-red-600">高風險寵物美容服務風險告知</h4>
                </div>
                <div class="text-xs text-red-900 leading-relaxed space-y-4 text-justify">
                    <div><span class="font-bold">一、飼主誠實告知義務</span><br>本人確認已完整告知寵物年齡、病史及行為特性。如因未告知致生意外，店家不負責任。</div>
                    <div><span class="font-bold">二、高齡與特殊健康狀況之風險</span><br>本人知悉高齡(8歲+)或幼體(1歲-)寵物，美容過程可能因緊張誘發休克、舊疾復發。若非店家故意或重大過失，店家不負賠償責任。</div>
                    <div><span class="font-bold">三、攻擊性與安全防護</span><br>若寵物有攻擊性，同意店家採取戴嘴套等防護措施。若危及安全，店家得隨時中止服務並收費。</div>
                    <div><span class="font-bold">四、緊急醫療處置</span><br>發生緊急狀況時，同意店家優先將寵物送醫，費用由本人負擔。</div>
                </div>
            </div>

            <div class="h-12"></div> </div>

        <div class="p-4 bg-white border-t border-brand-primary/10 shrink-0">
            <button type="button" onclick="app.toggleTermsModal(false)" class="w-full py-3.5 rounded-xl bg-brand-text text-white font-bold shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                <i data-lucide="check" class="w-4 h-4"></i> 我已閱讀完畢
            </button>
        </div>
    </div>
        <!-- 寵物選擇彈窗 (新增) -->
    <div id="petSelectModal" class="fixed inset-0 z-[9999] hidden bg-black/20 backdrop-blur-[2px] flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-[#F9F4F0] w-[90%] max-w-sm rounded-[32px] p-6 shadow-2xl transform scale-95 transition-transform duration-300 border border-white/50" id="petSelectContent">
            
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-brand-primary/10 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce-slight">
                    <i data-lucide="party-popper" class="w-8 h-8 text-brand-primary"></i>
                </div>
                <h3 class="text-xl font-bold text-brand-text font-serif tracking-widest mb-1">歡迎回來！</h3>
                <p class="text-xs text-brand-light tracking-wider">找到歷史紀錄，請確認要帶入的資料：</p>
            </div>

            <!-- 寵物列表容器 -->
            <div id="petListContainer" class="space-y-3 max-h-[50vh] overflow-y-auto custom-scrollbar pr-1 mb-4">
                <!-- JS 會自動產生內容放在這裡 -->
            </div>

            <div class="relative flex py-2 items-center">
                <div class="flex-grow border-t border-gray-200"></div>
                <span class="flex-shrink-0 mx-3 text-gray-300 text-xs">OR</span>
                <div class="flex-grow border-t border-gray-200"></div>
            </div>

            <button onclick="app.closePetSelectModal()" class="w-full py-3 rounded-xl border border-gray-300 text-gray-500 font-bold text-sm hover:bg-gray-50 transition flex items-center justify-center gap-2">
                <i data-lucide="pen-line" class="w-4 h-4"></i>
                不使用舊資料，填寫新表單
            </button>
        </div>
    </div>
</body>
</html>

