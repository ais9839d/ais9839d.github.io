<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>éº¥å…‹è«¾å°¼ | å¾Œå°ç®¡ç†ç³»çµ±</title>
    
    <!-- Favicon -->
    <link rel="icon" href="logo.jpg" type="image/jpeg">
    <link rel="apple-touch-icon" href="logo.jpg">
    
    <!-- å¥—ä»¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = { 
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#F9F4F0',       /* éŸ“ç³»ç±³ç™½èƒŒæ™¯ */
                            primary: '#C7B299',  /* éŸ“åœ‹å¥¶èŒ¶è‰² (ä¸»è‰²) */
                            secondary: '#E6CCCA',/* ä¹¾ç‡¥ç«ç‘°ç²‰ (é»ç¶´) */
                            dark: '#8A7B70',     /* æ·±å¥¶èŒ¶ (é‚Šæ¡†/å‰¯æ¨™) */
                            text: '#594A42',     /* æ·±ç„™å’–å•¡ (æ–‡å­—) */
                            light: '#9D816F',    /* æ·ºæ£•è‰² (èªªæ˜æ–‡å­—) */
                            surface: 'rgba(255, 255, 255, 0.65)' /* ç£¨ç ‚ç»ç’ƒèƒŒæ™¯ */
                        },
                    },
                    fontFamily: {
                        sans: ['Arial', 'Helvetica', 'sans-serif'],
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(89, 74, 66, 0.05)',
                        'card': '0 4px 12px -2px rgba(199, 178, 153, 0.1)',
                    },
                    animation: {
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: { from: { opacity: '0', transform: 'translateY(20px)' }, to: { opacity: '1', transform: 'translateY(0)' } },
                        fadeIn: { from: { opacity: '0' }, to: { opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #F9F4F0;
            color: #594A42;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* ç»ç’ƒæ“¬æ…‹å¡ç‰‡ */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.7); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8); 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-radius: 1.5rem;
        }

        .input-minimal {
            width: 100%;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(199, 178, 153, 0.2);
            padding: 0.8rem 1rem;
            font-size: 16px;
            border-radius: 12px;
            transition: all 0.3s;
            -webkit-appearance: none;
            appearance: none;
            color: #594A42;
        }
        .input-minimal:focus {
            border-color: #C7B299;
            box-shadow: 0 0 0 3px rgba(199, 178, 153, 0.1);
            outline: none;
            background: white;
        }

        /* éš±è—æ»¾å‹•æ¢ */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Toast æ¨£å¼ - éº¥å…‹è«¾å°¼é¢¨æ ¼ */
        .toast-container {
            position: fixed;
            top: calc(20px + env(safe-area-inset-top));
            right: 0;
            left: 0;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            min-width: 280px;
            max-width: 85%;
            padding: 12px 20px;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 30px rgba(89, 74, 66, 0.15);
            border: 1px solid rgba(199, 178, 153, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(-50px);
            opacity: 0;
            animation: toastSlideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            pointer-events: auto;
        }

        @keyframes toastSlideDown {
            to { transform: translateY(0); opacity: 1; }
        }

        .toast.removing {
            animation: toastFadeOut 0.3s ease forwards;
        }

        @keyframes toastFadeOut {
            to { transform: translateY(-20px); opacity: 0; }
        }

        /* ç‹€æ…‹é¡è‰²æŒ‡ç¤ºç·š (å·¦å´å°åœ“é») */
        .toast::before {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .toast.success::before { background-color: #10b981; box-shadow: 0 0 8px #10b981; }
        .toast.error::before { background-color: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .toast.warning::before { background-color: #f59e0b; box-shadow: 0 0 8px #f59e0b; }

        .toast-icon { width: 20px; height: 20px; flex-shrink: 0; }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 700; font-size: 0.9rem; color: #594A42; margin-bottom: 2px; }
        .toast-message { font-size: 0.75rem; color: #8A7B70; font-weight: 500; }
    </style>
</head>

<body class="min-h-screen relative flex flex-col max-w-4xl mx-auto shadow-2xl bg-[#F9F4F0]">

    <!-- Toast å®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>

    <!-- ç™»å…¥ç•«é¢ -->
    <div id="login-view" class="min-h-screen flex items-center justify-center p-6 animate-slide-up">
        <div class="glass-panel p-8 w-full max-w-sm text-center space-y-6">
            <div class="mx-auto w-24 h-24 rounded-full bg-white p-1 shadow-lg border border-brand-primary/20 -mt-16 mb-4 flex items-center justify-center">
                <img src="logo.jpg" onerror="this.src='https://placehold.co/100x100?text=Logo'" alt="Logo" class="w-full h-full object-cover rounded-full">
            </div>

            <div>
                <h1 class="text-2xl font-bold text-brand-text tracking-wider">éº¥å…‹è«¾å°¼å¾Œå°</h1>
                <p class="text-xs text-brand-light mt-1">Admin Dashboard</p>
            </div>

            <div class="space-y-4">
                <div class="relative">
                    <i data-lucide="lock" class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="password" id="admin-password" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼" 
                           class="input-minimal pl-12 pr-12 text-center tracking-widest" 
                           onkeydown="if(event.key==='Enter') handleLogin()">
                    <button type="button" onclick="togglePassword('admin-password')" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-brand-primary transition-colors">
                        <i data-lucide="eye" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <button onclick="handleLogin()" id="login-btn" class="w-full bg-brand-text text-white py-4 rounded-xl font-bold shadow-lg shadow-brand-text/20 active:scale-95 transition-all flex items-center justify-center gap-2">
                    ç™»å…¥ç³»çµ± <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="pt-4 border-t border-brand-primary/10">
                <a href="index.html" class="text-xs text-brand-light hover:text-brand-primary transition-colors inline-flex items-center gap-1">
                    <i data-lucide="arrow-left" class="w-3 h-3"></i> è¿”å›é¦–é 
                </a>
            </div>
        </div>
    </div>

    <!-- ä¸»æ§å°ç•«é¢ -->
    <div id="dashboard-view" class="hidden min-h-screen pb-24">
        <!-- é ‚éƒ¨å°èˆªåˆ— -->
        <nav class="bg-[#F9F4F0]/95 backdrop-blur-sm border-b border-brand-primary/10 sticky top-0 z-40">
            <div class="px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-full bg-brand-primary/10 flex items-center justify-center text-brand-primary border border-brand-primary/20">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    </div>
                    <span class="font-bold text-lg text-brand-text tracking-wider">å¾Œå°ç®¡ç†</span>
                </div>
<div class="flex items-center gap-2">
    <!-- é€™æ˜¯æ–°å¢çš„è®Šæ›´å¯†ç¢¼æŒ‰éˆ• -->
    <button onclick="openChangePasswordModal()" class="text-xs font-bold text-brand-light hover:text-brand-primary px-3 py-2 rounded-lg hover:bg-brand-primary/5 transition flex items-center gap-1.5" title="è®Šæ›´å¯†ç¢¼">
        <i data-lucide="key-round" class="w-4 h-4"></i> <span class="hidden sm:inline">è®Šæ›´å¯†ç¢¼</span>
    </button>
    
    <div class="w-px h-4 bg-gray-300 mx-1"></div>

    <!-- é€™æ˜¯åŸæœ¬çš„ç™»å‡ºæŒ‰éˆ• -->
    <button onclick="handleLogout()" class="text-xs font-bold text-brand-light hover:text-brand-primary px-3 py-2 rounded-lg hover:bg-brand-primary/5 transition flex items-center gap-1.5">
        <i data-lucide="log-out" class="w-4 h-4"></i> ç™»å‡º
    </button>
</div>
            </div>
        </nav>

        <div class="p-5 space-y-5">
            <!-- æ¨™é¡Œèˆ‡æœå°‹ -->
            <div class="flex flex-col gap-4">
                <div>
                    <h2 class="text-xl font-bold text-brand-text tracking-wider">ç¾å®¹å¥‘ç´„åˆ—è¡¨</h2>
                    <p class="text-xs text-brand-light mt-1">Service Contracts</p>
                </div>
                <div class="relative group">
                    <i data-lucide="search" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-brand-light/50 group-focus-within:text-brand-primary transition-colors"></i>
                    <input type="search" id="search-input" placeholder="æœå°‹å¯µç‰©åã€ä¸»äººå§“åã€é›»è©±..." 
                           class="input-minimal pl-10 py-2.5 text-sm bg-white/80">
                </div>
            </div>

            <!-- åˆ—è¡¨å®¹å™¨ -->
            <div id="content-area" class="space-y-3">
                <div class="text-center py-10 text-brand-light/50">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- è©³æƒ…/ç·¨è¼¯å½ˆçª— -->
    <div id="detail-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 p-4">
        <div class="bg-[#F9F4F0] w-full max-w-3xl rounded-[32px] flex flex-col shadow-2xl transform transition-all duration-300 max-h-[90vh] border border-white/50 relative" id="modal-panel">
            
            <!-- å½ˆçª—æ¨™é¡Œ -->
            <div class="p-6 border-b border-brand-primary/10 flex justify-between items-center bg-white/50 rounded-t-[32px] shrink-0">
                <div>
                    <h2 class="text-xl font-black text-brand-text tracking-wider">åˆç´„è©³æƒ…</h2>
                    <span class="text-[10px] text-brand-light uppercase tracking-widest font-bold" id="modal-id">ID: #0000</span>
                </div>
                <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-brand-light hover:text-brand-primary hover:shadow-md transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- å½ˆçª—å…§å®¹ -->
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1 space-y-6 bg-[#F9F4F0]" id="modal-content">
                <!-- JS å‹•æ…‹å¡«å…¥ -->
            </div>
            
            <!-- å½ˆçª—åº•éƒ¨æŒ‰éˆ• -->
            <div class="p-5 border-t border-brand-primary/10 bg-white/80 backdrop-blur rounded-b-none sm:rounded-b-[32px] flex justify-between items-center gap-3 shrink-0">
                <button onclick="requestDelete()" class="text-red-400 font-bold px-4 py-3 hover:bg-red-50 rounded-xl transition active:scale-95 flex items-center gap-2 text-sm">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> åˆªé™¤
                </button>
                <div class="flex gap-3 flex-1 justify-end">
                    <button onclick="enableEdit()" id="btn-edit" class="bg-white border border-brand-primary/20 text-brand-text px-6 py-3 rounded-xl font-bold hover:border-brand-primary hover:text-brand-primary transition active:scale-95 shadow-sm">
                        ç·¨è¼¯è³‡æ–™
                    </button>
                    <button onclick="saveChanges()" id="btn-save" class="hidden bg-brand-text text-white px-6 py-3 rounded-xl font-bold hover:bg-brand-dark transition active:scale-95 shadow-lg flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> å„²å­˜è®Šæ›´
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šç”¨å¯†ç¢¼é©—è­‰å½ˆçª— -->
    <div id="auth-modal" class="fixed inset-0 bg-brand-text/40 hidden z-[70] flex items-center justify-center p-6 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-[32px] w-full max-w-xs text-center space-y-6 shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="mx-auto w-16 h-16 rounded-full bg-brand-primary/5 flex items-center justify-center text-brand-primary mb-2">
                <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            
            <div class="space-y-2">
                <h3 class="text-xl font-black text-brand-text" id="auth-title">å®‰å…¨é©—è­‰</h3>
                <p class="text-sm text-brand-light font-medium" id="auth-desc">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥ç¹¼çºŒ</p>
            </div>

            <div class="relative group text-left">
                <i data-lucide="key" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-brand-light/50"></i>
                <input type="password" id="auth-password" placeholder="è¼¸å…¥å¯†ç¢¼" 
                       class="input-minimal pl-10 text-center tracking-widest bg-gray-50 border-gray-200"
                       onkeydown="if(event.key==='Enter') handleAuthConfirm()">
            </div>

            <div class="flex gap-3">
                <button onclick="closeAuthModal()" class="flex-1 py-3 bg-gray-100 text-brand-text font-bold rounded-xl active:scale-95 transition">å–æ¶ˆ</button>
                <button onclick="handleAuthConfirm()" id="auth-confirm-btn" class="flex-1 py-3 bg-brand-text text-white font-bold rounded-xl shadow-lg shadow-brand-text/20 active:scale-95 transition">
                    ç¢ºèª
                </button>
            </div>
        </div>
    </div>
<!-- è®Šæ›´å¯†ç¢¼å½ˆçª— -->
<div id="change-pwd-modal" class="fixed inset-0 bg-brand-text/40 hidden z-[80] flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
    <div class="bg-white p-8 rounded-[24px] w-full max-w-[400px] shadow-2xl transform scale-95 transition-transform duration-300 relative">
        
        <!-- é—œé–‰æŒ‰éˆ• -->
        <button onclick="closeChangePasswordModal()" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 transition">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>

        <h3 class="text-xl font-bold text-brand-text mb-8 tracking-wider">è®Šæ›´ç®¡ç†å¯†ç¢¼</h3>

        <div class="space-y-4">
            <!-- èˆŠå¯†ç¢¼ -->
            <div class="relative group">
                <i data-lucide="lock" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-brand-light/50"></i>
                <input type="password" id="cp-old-password" placeholder="è¼¸å…¥èˆŠå¯†ç¢¼" 
                       class="w-full bg-[#F9F4F0] border border-transparent focus:bg-white focus:border-brand-primary/30 rounded-xl py-3 pl-11 pr-4 text-sm text-brand-text outline-none transition-all placeholder:text-gray-400">
            </div>

            <!-- æ–°å¯†ç¢¼ -->
            <div class="relative group">
                <i data-lucide="key" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-brand-light/50"></i>
                <input type="password" id="cp-new-password" placeholder="æ–°å¯†ç¢¼ (è‡³å°‘6ä½)" 
                       class="w-full bg-[#F9F4F0] border border-transparent focus:bg-white focus:border-brand-primary/30 rounded-xl py-3 pl-11 pr-4 text-sm text-brand-text outline-none transition-all placeholder:text-gray-400">
            </div>

            <!-- ç¢ºèªæ–°å¯†ç¢¼ -->
            <div class="relative group">
                <i data-lucide="shield-check" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-brand-light/50"></i>
                <input type="password" id="cp-confirm-password" placeholder="ç¢ºèªæ–°å¯†ç¢¼" 
                       class="w-full bg-[#F9F4F0] border border-transparent focus:bg-white focus:border-brand-primary/30 rounded-xl py-3 pl-11 pr-4 text-sm text-brand-text outline-none transition-all placeholder:text-gray-400">
            </div>
        </div>

        <div class="flex gap-3 mt-8">
            <button onclick="closeChangePasswordModal()" class="flex-1 py-3 bg-[#F3F4F6] text-brand-text font-bold rounded-xl hover:bg-gray-200 transition text-sm">
                å–æ¶ˆ
            </button>
            <button onclick="handleChangePassword()" id="btn-change-pwd" class="flex-1 py-3 bg-brand-text text-white font-bold rounded-xl shadow-lg hover:bg-brand-dark active:scale-95 transition text-sm flex items-center justify-center gap-2">
                ç¢ºèªä¿®æ”¹
            </button>
        </div>
    </div>
</div>
<script>
    // åˆå§‹åŒ–
    lucide.createIcons();

    // --- Supabase è¨­å®š ---
    const SUPABASE_URL = 'https://sudsagtksfdgkvxjtcze.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN1ZHNhZ3Rrc2ZkZ2t2eGp0Y3plIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNDc3ODIsImV4cCI6MjA4NDgyMzc4Mn0.J_ZH5rA2uSG2m5pt76-7l95etd9reB4pePQDZs5GZMI'; 
    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // é è¨­ç®¡ç†å“¡ Email (èˆ‡å‰ç«¯ç”¨æˆ¶å€åˆ†)
    const ADMIN_EMAIL = 'ais9839d@gmail.com';

    // å…¨åŸŸè®Šæ•¸
    let fullDataList = [];
    let currentItem = null;
    let pendingAction = null; // å„²å­˜å¾…åŸ·è¡Œçš„å‹•ä½œ ('save' æˆ– 'delete')

    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    async function checkSession() {
        const { data: { session } } = await _supabase.auth.getSession();
        if (session) { 
            showDashboard();
        }
    }
    checkSession();

    // é¡¯ç¤ºä¸»æ§å°
    function showDashboard() {
        document.getElementById('login-view').classList.add('hidden'); 
        document.getElementById('dashboard-view').classList.remove('hidden'); 
        loadData(); 
    }

    // ç™»å…¥è™•ç†
    async function handleLogin() {
        const btn = document.getElementById('login-btn');
        const originalBtnHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i>';
        lucide.createIcons();

        const password = document.getElementById('admin-password').value;
        
        if (!password) {
            showToast('è«‹è¼¸å…¥å¯†ç¢¼', 'error');
            btn.disabled = false;
            btn.innerHTML = originalBtnHTML;
            return;
        }

        const { error } = await _supabase.auth.signInWithPassword({ email: ADMIN_EMAIL, password });
        
        if (error) {
            showToast('å¯†ç¢¼éŒ¯èª¤', 'error');
            document.getElementById('admin-password').value = '';
            btn.disabled = false;
            btn.innerHTML = originalBtnHTML;
        } else {
            showToast('ç™»å…¥æˆåŠŸï¼', 'success');
            showDashboard();
        }
    }

    // ç™»å‡º
    async function handleLogout() {
        await _supabase.auth.signOut();
        location.reload();
    }

    // è¼‰å…¥è³‡æ–™
    async function loadData() {
        const container = document.getElementById('content-area');
        
        // éª¨æ¶å±
        container.innerHTML = Array(5).fill(0).map(() => `
            <div class="glass-panel p-4 rounded-2xl flex justify-between items-center skeleton-card">
                <div class="space-y-2 w-1/2">
                    <div class="h-4 bg-gray-200 rounded w-1/3"></div>
                    <div class="h-6 bg-gray-200 rounded w-2/3"></div>
                </div>
                <div class="h-8 w-20 bg-gray-200 rounded-lg"></div>
            </div>
        `).join('');

        const { data, error } = await _supabase
            .from('bookings') // é€™è£¡å°æ‡‰è³‡æ–™è¡¨åç¨±
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            container.innerHTML = `<div class="text-center text-red-400 py-10">è®€å–éŒ¯èª¤: ${error.message}</div>`;
            return;
        }

        fullDataList = data;
        renderDataList(data);
    }

    // æ¸²æŸ“åˆ—è¡¨
    function renderDataList(data) {
        const container = document.getElementById('content-area');
        
        if (!data || data.length === 0) {
            container.innerHTML = `
                <div class="text-center py-16">
                    <div class="w-20 h-20 bg-brand-light/5 rounded-full flex items-center justify-center mx-auto mb-4">
                         <i data-lucide="file-x" class="w-10 h-10 text-brand-light/30"></i>
                    </div>
                    <p class="text-brand-light font-bold">æš«ç„¡è³‡æ–™</p>
                </div>`;
            lucide.createIcons();
            return;
        }

        container.innerHTML = data.map((item, index) => {
            const date = new Date(item.created_at).toLocaleString('zh-TW', {
                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });

            // 1. åˆ¤æ–·æ˜¯å¦æœ‰é¢¨éšªæ¨™ç±¤ (æ”»æ“Šæ€§ã€ä¸è¦ªç‹—)
            const hasRisk = item.temperament === 'æ°åŒ—åŒ—/è­·ä¸»' || item.social_interaction === 'ä¸å¯èˆ‡ç‹—ç©';
            const riskTag = hasRisk ? 
                `<span class="px-2 py-0.5 rounded-md bg-red-100 text-red-500 text-[10px] font-bold whitespace-nowrap">éœ€æ³¨æ„</span>` : '';

            // 2. åˆ¤æ–·æ˜¯å¦æœ‰å‚™è¨»
            const hasNotes = item.admin_notes && item.admin_notes.trim().length > 0;
            const noteTag = hasNotes ? 
                `<span class="px-2 py-0.5 rounded-md bg-brand-primary/10 text-brand-text text-[10px] font-bold flex items-center gap-1 whitespace-nowrap"><i data-lucide="sticky-note" class="w-3 h-3"></i> å‚™è¨»</span>` : '';

            // 3. åˆ¤æ–·æ˜¯å¦æœ‰ç—…å²
            const hasHistory = item.medical_history === 'æœ‰';
            const historyTag = hasHistory ? 
                `<span class="px-2 py-0.5 rounded-md bg-blue-50 text-blue-600 text-[10px] font-bold whitespace-nowrap">ç—…å²</span>` : '';
            
            // åªæœ‰åœ¨æœ‰é¢¨éšªã€å‚™è¨»æˆ–ç—…å²æ™‚ï¼Œæ‰é¡¯ç¤ºé€™ä¸€æ•´è¡Œ div
            const tagsHtml = (riskTag || noteTag || historyTag) ? 
                `<div class="flex items-center gap-2 flex-wrap mt-1">${riskTag}${noteTag}${historyTag}</div>` : '';

            return `
<div onclick="openModal('${item.id}')" class="glass-panel p-5 rounded-2xl flex justify-between items-center cursor-pointer hover:shadow-lg hover:-translate-y-1 active:scale-[0.98] transition-all duration-200 group border-l-4 border-l-transparent hover:border-l-brand-primary">
                <div class="flex items-center gap-4 w-full overflow-hidden">
                    <div class="w-12 h-12 rounded-full bg-brand-primary/10 text-brand-primary flex items-center justify-center font-bold text-lg shrink-0">
                        ${item.pet_name ? item.pet_name[0] : '?'}
                    </div>
                    <div class="flex-1 min-w-0">
                        <!-- ç¬¬ä¸€è¡Œï¼šåå­— + ä¸»äºº -->
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-brand-text text-lg truncate">${item.pet_name}</h3>
                            <span class="text-xs text-brand-light truncate">(${item.owner_name})</span>
                        </div>
                        
                        <!-- ç¬¬äºŒè¡Œï¼šæ¨™ç±¤å€ -->
                        ${tagsHtml}
                        
                        <!-- ç¬¬ä¸‰è¡Œï¼šè³‡è¨Š -->
                        <div class="flex items-center gap-3 mt-2 text-xs text-brand-light font-medium truncate">
                            <span class="flex items-center gap-1"><i data-lucide="scissors" class="w-3 h-3"></i> ${item.service_type}</span>
                            <span class="w-1 h-1 rounded-full bg-gray-300"></span>
                            <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${date}</span>
                        </div>
                    </div>
                </div>
                <div class="text-right hidden sm:block pl-4 shrink-0">
                    <span class="text-xs font-bold text-brand-primary border border-brand-primary/30 px-3 py-1 rounded-full group-hover:bg-brand-primary group-hover:text-white transition-colors">
                        æŸ¥çœ‹
                    </span>
                </div>
            </div>`;
        }).join('');
            // é‡æ–°æ¸²æŸ“åœ–ç¤º
        if (container.children.length === 0 || container.innerText.includes('è¼‰å…¥ä¸­')) {
             lucide.createIcons();
        }
    }


    // æœå°‹åŠŸèƒ½ (åŠ å…¥é˜²æŠ– Debounce)
    let searchTimeout;
    document.getElementById('search-input').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const filtered = fullDataList.filter(item => 
                (item.owner_name && item.owner_name.includes(term)) ||
                (item.owner_phone && item.owner_phone.includes(term)) ||
                (item.pet_name && item.pet_name.includes(term))
            );
            renderDataList(filtered);
        }, 500);
    });


    // é–‹å•Ÿè©³æƒ…å½ˆçª—
    function openModal(id) {
        currentItem = fullDataList.find(i => i.id == id);
        
        if (!currentItem) {
            alert("ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è©²ç­†è³‡æ–™");
            return;
        }

        const idStr = String(currentItem.id);
        document.getElementById('modal-id').innerText = `ID: #${idStr.length > 8 ? idStr.substring(0, 8) : idStr}`;
        
        const content = document.getElementById('modal-content');
        
        const sections = [
            {
                title: 'ğŸ‘¤ é£¼ä¸»è³‡æ–™',
                fields: [
                    { label: 'å§“å', key: 'owner_name' },
                    { label: 'é›»è©±', key: 'owner_phone' },
                    { label: 'Email', key: 'email' },
                    { label: 'èº«åˆ†è­‰', key: 'owner_id' },
                    { label: 'åœ°å€', key: 'address', full: true }
                ]
            },
            {
                title: 'ğŸš‘ ç·Šæ€¥è¯çµ¡',
                fields: [
                    { label: 'è¯çµ¡äºº', key: 'emergency_name' },
                    { label: 'ç·Šæ€¥é›»è©±', key: 'emergency_phone' },
                    { label: 'æŒ‡å®šé†«é™¢', key: 'preferred_clinic', full: true }
                ]
            },
            {
                title: 'ğŸ¾ å¯µç‰©è³‡æ–™',
                fields: [
                    { label: 'åå­—', key: 'pet_name' },
                    { label: 'ç¨®é¡', key: 'pet_species' },
                    { label: 'å“ç¨®', key: 'breed' },
                    { label: 'é«”é‡', key: 'weight', suffix: ' kg' },
                    { label: 'å¹´é½¡', key: 'age', suffix: ' æ­²' },
                    { label: 'æ€§åˆ¥', key: 'gender' },
                    { label: 'çµç´®', key: 'ligation' },
                    { label: 'æ™¶ç‰‡ç‹€æ³', key: 'chip_status' },
                    { label: 'æ™¶ç‰‡è™Ÿç¢¼', key: 'chip_id', full: true }
                ]
            },
            {
                title: 'âš ï¸ è¡Œç‚ºèˆ‡å¥åº·',
                fields: [
                    { label: 'å°äººåæ‡‰', key: 'social_aggression' },
                    { label: 'è¦ªç‹—ç‹€æ³', key: 'social_interaction' },
                    { label: 'æ€§æƒ…è©•ä¼°', key: 'temperament', highlight: 'æ°åŒ—åŒ—/è­·ä¸»' },
                    { label: 'ç—…å²', key: 'medical_history', highlight: 'æœ‰' },
                    { label: 'ç—…å²è©³æƒ…', key: 'medical_detail', full: true }
                ]
            },
            {
                title: 'âœ‚ï¸ æœå‹™å…§å®¹',
                fields: [
                    { label: 'æœå‹™é¡å‹', key: 'service_type' },
                    { label: 'å‡ç´šé …ç›®', key: 'spa_upgrades', full: true, isTag: true },
                    { label: 'åŸºç¤å ±åƒ¹', key: 'base_price', prefix: '$' },
                    { label: 'å‡ç´šåŠ åƒ¹', key: 'upgrade_price', prefix: '+' },
                    { label: 'é ä¼°ç¸½é¡', key: 'total_price', prefix: '$', highlight: true },
                    { label: 'æ”¯ä»˜æ–¹å¼', key: 'payment_method' }
                ]
            },
            {
                title: 'âš ï¸ ç‰¹æ®Šæœå‹™',
                fields: [
                    { label: 'ç–‘ä¼¼æ‰“çµ', key: 'matting_suspected', isBool: true },
                    { label: 'æ‰“çµè™•ç†æ–¹å¼', key: 'matting_choice', full: true }
                ]
            }
        ];

        let html = '';

        // --- å‚™è¨»å€å¡Š ---
        const notes = currentItem.admin_notes || '';
        const noteDisplayClass = notes ? 'whitespace-pre-wrap text-brand-text' : 'text-gray-400 italic';
        const noteDisplayText = notes ? notes : 'é»æ“Šä¸‹æ–¹ã€Œç·¨è¼¯è³‡æ–™ã€å³å¯æ–°å¢å‚™è¨»...';

        html += `
            <div class="glass-panel rounded-2xl p-5 border-l-4 border-l-brand-primary mb-6 shadow-sm">
                <h3 class="font-bold text-brand-text text-sm mb-2 flex items-center gap-2">
                    <i data-lucide="notebook-pen" class="w-4 h-4 text-brand-primary"></i> åº—å®¶å‚™è¨»
                </h3>
                <div class="view-mode text-sm min-h-[20px] leading-relaxed ${noteDisplayClass}">${noteDisplayText}</div>
                <textarea data-key="admin_notes" class="edit-mode hidden input-minimal w-full h-24 text-sm resize-none focus:ring-2 focus:ring-brand-primary/20" placeholder="è«‹è¼¸å…¥å‚™è¨»äº‹é …...">${notes}</textarea>
            </div>
        `;
        
        // --- å…¶ä»–è³‡æ–™å€å¡Š ---
        sections.forEach(section => {
            html += `
                <div class="glass-panel rounded-2xl overflow-hidden mb-4 border border-white/60">
                    <div class="bg-brand-primary/5 px-5 py-3 border-b border-brand-primary/10">
                        <h3 class="font-bold text-brand-text text-sm">${section.title}</h3>
                    </div>
                    <div class="p-5 grid grid-cols-1 sm:grid-cols-2 gap-4">
            `;
            
            section.fields.forEach(f => {
                let val = currentItem[f.key];
                if (val === null || val === undefined) val = '-';

                const colSpan = f.full ? 'sm:col-span-2' : '';
                
                // ç‰¹æ®Šè™•ç†ï¼šå¸ƒæ—å€¼ (ç–‘ä¼¼æ‰“çµ)
                if (f.isBool) {
                    val = (val === true) ? '<span class="text-red-500 font-bold">æ˜¯</span>' : '<span class="text-gray-400">å¦</span>';
                }
                // ç‰¹æ®Šè™•ç†ï¼šæ¨™ç±¤æ¨£å¼ (Services, Spa Upgrades)
                else if (f.isTag && val !== '-' && val.length > 0) {
                    // å°‡å­—ä¸²è½‰ç‚ºé™£åˆ—ä¸¦æ¸²æŸ“æ¨™ç±¤
                    const tags = typeof val === 'string' ? val.split(',').map(s => s.trim()) : [];
                    val = tags.map(v => 
                        `<span class="inline-block px-2 py-0.5 rounded bg-brand-primary/10 text-brand-text text-xs font-bold mr-1 mb-1">${v}</span>`
                    ).join('');
                } 
                // ç‰¹æ®Šè™•ç†ï¼šé«˜äº®é¡¯ç¤º (æ”»æ“Šæ€§ã€ç—…å²)
                else if (f.highlight === true || val === f.highlight) {
                    val = `<span class="text-brand-primary font-bold">${val}</span>`;
                }

                // è™•ç†å‰ç¶´ (ä¾‹å¦‚ $, +)
                let displayVal = val;
                if (f.prefix && val !== '-') displayVal = f.prefix + val;
                if (f.suffix && val !== '-') displayVal = val + f.suffix;

                html += `
                    <div class="${colSpan}">
                        <label class="block text-[10px] font-bold text-brand-light mb-1 uppercase tracking-wider">${f.label}</label>
                        <div class="view-mode text-sm font-bold text-brand-text min-h-[24px] flex items-center">
                            ${displayVal}
                        </div>
                        <input type="text" data-key="${f.key}" value="${currentItem[f.key] || ''}" 
                            class="edit-mode hidden input-minimal py-1.5 px-3 text-sm h-9">
                    </div>
                `;
            });

            html += `</div></div>`;
        });

        if (currentItem.signature_data) {
            // æ ¼å¼åŒ–ç°½ç½²æ™‚é–“
            const signTime = currentItem.created_at ? new Date(currentItem.created_at).toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }) : 'æ™‚é–“æœªçŸ¥';

            html += `
                <div class="glass-panel rounded-2xl p-5 border border-white/60 mt-4">
                    <h3 class="font-bold text-brand-text text-sm mb-3 flex items-center gap-2">
                        âœï¸ é›»å­ç°½å
                        <span class="text-xs font-normal text-brand-light bg-brand-primary/10 px-2 py-0.5 rounded-full">
                            ç°½ç½²æ–¼ ${signTime}
                        </span>
                    </h3>
                    <div class="bg-white/50 rounded-xl p-4 border border-dashed border-brand-text/20 flex justify-center">
                        <img src="${currentItem.signature_data}" class="max-h-24 object-contain">
                    </div>
                </div>
            `;
        }

        content.innerHTML = html;
        lucide.createIcons();

        document.getElementById('btn-edit').classList.remove('hidden');
        document.getElementById('btn-save').classList.add('hidden');
        
        const modal = document.getElementById('detail-modal');
        const panel = document.getElementById('modal-panel');
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            panel.classList.remove('translate-y-full');
        }, 10);
    }

    // é—œé–‰è©³æƒ…å½ˆçª—
    function closeModal() {
        const modal = document.getElementById('detail-modal');
        const panel = document.getElementById('modal-panel');
        modal.classList.add('opacity-0');
        panel.classList.add('translate-y-full');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    // å•Ÿç”¨ç·¨è¼¯æ¨¡å¼
    function enableEdit() {
        document.getElementById('btn-edit').classList.add('hidden');
        document.getElementById('btn-save').classList.remove('hidden');
        
        document.querySelectorAll('.view-mode').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.edit-mode').forEach(el => el.classList.remove('hidden'));
        
        showToast('å·²é€²å…¥ç·¨è¼¯æ¨¡å¼', 'success');
    }

    // --- å®‰å…¨é©—è­‰é‚è¼¯ ---

    // é–‹å•Ÿé©—è­‰å½ˆçª—
    function showAuthModal(actionType) {
        pendingAction = actionType;
        
        const titleEl = document.getElementById('auth-title');
        const descEl = document.getElementById('auth-desc');
        
        if (actionType === 'save') {
            titleEl.innerText = 'å®‰å…¨é©—è­‰';
            descEl.innerText = 'ä¿®æ”¹è³‡æ–™éœ€è¼¸å…¥ç®¡ç†å¯†ç¢¼';
        } else if (actionType === 'delete') {
            titleEl.innerText = 'åˆªé™¤ç¢ºèª';
            descEl.innerText = 'åˆªé™¤æ­¤ç­†è³‡æ–™éœ€è¼¸å…¥ç®¡ç†å¯†ç¢¼';
        }

        document.getElementById('auth-password').value = '';
        
        const modal = document.getElementById('auth-modal');
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
        
        setTimeout(() => document.getElementById('auth-password').focus(), 100);
    }

    // é—œé–‰é©—è­‰å½ˆçª—
    function closeAuthModal() {
        const modal = document.getElementById('auth-modal');
        modal.classList.add('opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            pendingAction = null; 
        }, 300);
    }

    // è™•ç†é©—è­‰ç¢ºèª
    async function handleAuthConfirm() {
        const btn = document.getElementById('auth-confirm-btn');
        const originalText = btn.innerHTML;
        const password = document.getElementById('auth-password').value;
        
        if (!password) {
            showToast('è«‹è¼¸å…¥å¯†ç¢¼', 'error');
            return;
        }

        try {
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i>';
            btn.disabled = true;
            lucide.createIcons();

            // é©—è­‰å¯†ç¢¼ (ä½¿ç”¨ç™»å…¥é‚è¼¯)
            const { error } = await _supabase.auth.signInWithPassword({
                email: ADMIN_EMAIL,
                password: password
            });

            if (error) throw error;

            const action = pendingAction;
            closeAuthModal();
            
            setTimeout(() => {
                if (action === 'save') executeSave();
                else if (action === 'delete') executeDelete();
            }, 300);

        } catch (error) {
            console.error(error);
            showToast('å¯†ç¢¼éŒ¯èª¤', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            lucide.createIcons();
        }
    }

    // é»æ“Šã€Œå„²å­˜è®Šæ›´ã€æŒ‰éˆ•
    function saveChanges() {
        let hasChanges = false;

        document.querySelectorAll('.edit-mode').forEach(input => {
            const key = input.dataset.key;
            if (!key) return;
            
            let originalValue = currentItem[key];
            if (originalValue === null || originalValue === undefined) originalValue = '';
            
            let newValue = input.value;
            
            if (String(originalValue).trim() !== String(newValue).trim()) {
                hasChanges = true;
            }
        });

        if (!hasChanges) {
            showToast('æœªåµæ¸¬åˆ°ä»»ä½•è®Šæ›´', 'info');
            openModal(currentItem.id);
            return;
        }

        // ä¿®æ”¹è³‡æ–™éœ€è¦é©—è­‰å¯†ç¢¼
        showAuthModal('save');
    }

    // é»æ“Šã€Œåˆªé™¤ã€æŒ‰éˆ•
    function requestDelete() {
        showAuthModal('delete');
    }

    // çœŸæ­£çš„å„²å­˜åŸ·è¡Œå‡½å¼
    async function executeSave() {
        console.log('é–‹å§‹åŸ·è¡Œå„²å­˜...'); 
        console.log('æº–å‚™æ›´æ–°çš„è³‡æ–™:', currentItem.id); 

        const btn = document.getElementById('btn-save');
        if (!btn) return;
        const originalText = btn.innerHTML;
        
        try {
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> å„²å­˜ä¸­...';
            btn.disabled = true;
            lucide.createIcons();

            const updates = {};
            document.querySelectorAll('.edit-mode').forEach(input => {
                const key = input.dataset.key;
                if (key) {
                    let value = input.value;
                    updates[key] = value;
                }
            });

            const { error } = await _supabase
                .from('bookings')
                .update(updates)
                .eq('id', currentItem.id)
                .select();
                

            if (error) throw error;

            showToast('è³‡æ–™å·²æ›´æ–°', 'success');
            closeModal();
            loadData();

        } catch (error) {
            console.error('Save Error:', error);
            showToast('å„²å­˜å¤±æ•—: ' + error.message, 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }


    // åŸ·è¡Œåˆªé™¤
    async function executeDelete() {
        const { error } = await _supabase
            .from('bookings')
            .delete()
            .eq('id', currentItem.id)
            .select();

        if (error) {
            showToast('åˆªé™¤å¤±æ•—: ' + error.message, 'error');
        } else {
            showToast('å·²åˆªé™¤è©²ç­†è³‡æ–™', 'success');
            closeModal();
            loadData();
        }
    }

    // Toast æç¤º
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        
        // é¡è‰²è¨­å®š
        const borderColors = {
            success: '#10B981',
            error: '#EF4444',
            info: '#3B82F6'
        };
        const borderColor = borderColors[type] || borderColors.success;
        
        el.className = `toast ${type}`;
        el.style.borderColor = borderColor; // å‹•æ…‹è¨­å®šé‚Šæ¡†é¡è‰²
        
        // å…§å®¹ HTML
        el.innerHTML = `
            <div class="toast-icon text-white rounded-full p-1 mr-3 flex items-center justify-center" style="background-color: ${borderColor}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3 h-3"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
            </div>
            <div class="toast-content">
                <div class="toast-title">${type === 'success' ? 'æˆåŠŸ' : (type === 'error' ? 'éŒ¯èª¤' : 'é€šçŸ¥')}</div>
                <div class="toast-message">${message}</div>
            </div>
            <div class="toast-close cursor-pointer text-gray-400 hover:text-gray-600 ml-2" onclick="this.parentElement.remove()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        `;
        
        container.appendChild(el);
        lucide.createIcons();

        // é¡¯ç¤ºå‹•ç•«
        requestAnimationFrame(() => {
            el.style.transform = 'translateY(0)';
            el.style.opacity = '1';
        });

        // è‡ªå‹•æ¶ˆå¤±
        setTimeout(() => {
            el.classList.add('removing');
            el.addEventListener('animationend', () => {
                if(el.parentElement) el.remove();
            });
        }, 3000);
    }

    // å¯†ç¢¼é¡¯ç¤ºåˆ‡æ›
    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const icon = input.nextElementSibling.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.setAttribute('data-lucide', 'eye-off');
        } else {
            input.type = 'password';
            icon.setAttribute('data-lucide', 'eye');
        }
        lucide.createIcons();
    }
    // --- è®Šæ›´å¯†ç¢¼åŠŸèƒ½ ---

function openChangePasswordModal() {
    const modal = document.getElementById('change-pwd-modal');
    // æ¸…ç©ºæ¬„ä½
    document.getElementById('cp-old-password').value = '';
    document.getElementById('cp-new-password').value = '';
    document.getElementById('cp-confirm-password').value = '';
    
    modal.classList.remove('hidden');
    setTimeout(() => modal.classList.remove('opacity-0'), 10);
    lucide.createIcons();
}

function closeChangePasswordModal() {
    const modal = document.getElementById('change-pwd-modal');
    modal.classList.add('opacity-0');
    setTimeout(() => modal.classList.add('hidden'), 300);
}

async function handleChangePassword() {
    const oldPwd = document.getElementById('cp-old-password').value;
    const newPwd = document.getElementById('cp-new-password').value;
    const confirmPwd = document.getElementById('cp-confirm-password').value;
    const btn = document.getElementById('btn-change-pwd');
    const originalText = btn.innerHTML;

    // 1. åŸºæœ¬é©—è­‰
    if (!oldPwd || !newPwd || !confirmPwd) {
        showToast('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
        return;
    }
    if (newPwd.length < 6) {
        showToast('æ–°å¯†ç¢¼é•·åº¦éœ€è‡³å°‘ 6 ä½', 'error');
        return;
    }
    if (newPwd !== confirmPwd) {
        showToast('å…©æ¬¡æ–°å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´', 'error');
        return;
    }

    try {
        btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> è™•ç†ä¸­';
        btn.disabled = true;
        lucide.createIcons();

        // 2. é©—è­‰èˆŠå¯†ç¢¼æ˜¯å¦æ­£ç¢º (é‡æ–°ç™»å…¥ä¸€æ¬¡ä¾†é©—è­‰)
        const { error: signInError } = await _supabase.auth.signInWithPassword({
            email: 'ais9839d@gmail.com', // é€™è£¡ä½¿ç”¨æ‚¨çš„ç®¡ç†å“¡ Email
            password: oldPwd
        });

        if (signInError) {
            throw new Error('èˆŠå¯†ç¢¼éŒ¯èª¤');
        }

        // 3. æ›´æ–°å¯†ç¢¼
        const { error: updateError } = await _supabase.auth.updateUser({ 
            password: newPwd 
        });

        if (updateError) throw updateError;

        // ä¿®æ”¹æˆåŠŸå¾Œçš„å‹•ä½œ
        await _supabase.auth.signOut(); // å¼·åˆ¶ç™»å‡º
        showToast('å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼Œè«‹é‡æ–°ç™»å…¥', 'success');
        setTimeout(() => {
            location.reload(); // é‡æ–°æ•´ç†é é¢å›åˆ°ç™»å…¥ç•«é¢
        }, 1500);

    } catch (error) {
        console.error(error);
        showToast(error.message || 'ä¿®æ”¹å¤±æ•—', 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
        lucide.createIcons();
    }
}

</script>
</body>
</html>